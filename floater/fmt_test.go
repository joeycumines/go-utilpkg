package floater

import (
	"bytes"
	"fmt"
	"golang.org/x/exp/maps"
	"golang.org/x/exp/slices"
	"math"
	"math/big"
	"math/rand/v2"
	"strconv"
	"strings"
	"testing"
)

func isNumericByte(b byte) bool {
	return b >= '0' && b <= '9'
}

var bmr string

func runBenchmarkFormatDecimalRat(b *testing.B, input string, prec int, floatPrec uint, output string) {
	b.Helper()
	r, _ := new(big.Rat).SetString(input)
	b.ReportAllocs()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		bmr = FormatDecimalRat(r, prec, floatPrec)
	}
	if bmr != output {
		b.Fatalf(`unexpected output: %q != %q`, bmr, output)
	}
}

func runBenchmarkBigRatFloatString(b *testing.B, input string, prec int) {
	b.Helper()
	r, _ := new(big.Rat).SetString(input)
	b.ReportAllocs()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		bmr = r.FloatString(prec)
	}
	b.StopTimer()
	dec := len(bmr) - 1 - prec
	if dec < 0 || dec >= len(bmr) || (bmr[dec] == '.') != (prec != 0) {
		b.Fatalf(`unexpected output (%d): %q`, prec, bmr)
	}
}

func runBenchmarkBigRatFloatText(b *testing.B, input string, prec int, floatPrec uint, auto bool) {
	b.Helper()
	r, _ := new(big.Rat).SetString(input)
	f := new(big.Float).SetPrec(floatPrec).SetRat(r)
	var precForCall int
	if auto {
		precForCall = -1
	} else {
		precForCall = prec
	}
	b.ReportAllocs()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		bmr = f.Text('f', precForCall)
	}
	b.StopTimer()
	if !auto {
		dec := len(bmr) - 1 - prec
		if dec < 0 || dec >= len(bmr) || (bmr[dec] == '.') != (prec != 0) {
			b.Fatalf(`unexpected output (specific, %d): %q`, prec, bmr)
		}
	}
}

func runBenchmarkStrconvFormatFloat(b *testing.B, input string, prec int, auto bool) {
	b.Helper()
	r, _ := new(big.Rat).SetString(input)
	f, _ := r.Float64()
	var precForCall int
	if auto {
		precForCall = -1
	} else {
		precForCall = prec
	}
	b.ReportAllocs()
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		bmr = strconv.FormatFloat(f, 'f', precForCall, 64)
	}
	b.StopTimer()
	if !auto {
		dec := len(bmr) - 1 - prec
		if dec < 0 || dec >= len(bmr) || (bmr[dec] == '.') != (prec != 0) {
			b.Fatalf(`unexpected output (specific, %d): %q`, prec, bmr)
		}
	}
}

func BenchmarkFormatDecimalRat(b *testing.B) {
	for _, tc := range [...]struct {
		name      string
		input     string
		prec      int
		floatPrec uint
		output    string
	}{
		{"DecimalRat_1", "-18446744073709551557/480", -1, 0, "-38430716820228232.41042"},
		{"DecimalRat_2", "1/4", -1, 0, "0.25"},
		{"DecimalRat_3", "213872935/24", -1, 0, "8911372.291666666666667"},
		{"DecimalRat_4", "213872935/24", 3, 0, "8911372.292"},
		{"DecimalRat_5", "213872935/24", -1, 256, "8911372.2916666666666666666666666666666666666666666666666666666666666666666666667"},
		{"DecimalRat_6", "15665333063902/12633333116050000", -1, 0, "0.00124"},
		{"DecimalRat_7", "25247716232425925/12633333116050000", 2, 0, "2.00"},
		{"SmallInteger", "42/1", -1, 0, "42"},
		{"LargeInteger", "123456789012345678901234567890/1", -1, 0, "123456789012345678901234567890"},
		{"SmallRationalAutoPrec", "1/3", -1, 64, "0.333333333333333333333"},
		{"LargeRationalSpecificPrec", "12345678901234567890/1234567890123456789", 10, 128, "10.0000000000"},
		{"HighPrecision", "1/7", 100, 0, "0.1428571428571428571428571428571428571428571428571428571428571428571428571428571428571428571428571429"},
		{"EdgeZero", "0/1", 5, 64, "0.00000"},
		{"LargeFloatPrec", "123456789012345678901234567890/1234567890123456789", -1, 256, "100000000000.000000000999999999900000000009999999999000000000099999999990000000001"},
		{"ExtremelyLargeInteger", "1234567890123456789012345678901234567890123456789092148752366384884934577583924399439234023400234857557771/1", -1, 0, "1234567890123456789012345678901234567890123456789092148752366384884934577583924399439234023400234857557771"},
		{"LargeRationalHighPrecision", "123456789012345678901/987654321", 100, 0, "124999998873.4374999013445312512331933593595850830080051864623999351692200008103847499898701906251266226171859172"},
		{"SmallRationalExtremePrecision", "1/3", 1000, 0, "0." + strings.Repeat("3", 1000)},
		{"LargeRationalLargeFloatPrec", "12345678901234567891/1234567890123456789", -1, 1024, "10.0000000000000000008100000072900000663471006037578054941961109971846019743798787768568967883977607825196231201185703931599905777478142575059197433037886640644849429868121711799908387379166244150412829868756750995686434141746550681793611205131861966618943896240489455787644047667641833775532587357347354951860849"},
		{"LargeRationalExtremelyLargeFloatPrec", "12345678901234567891/1234567890123456789", -1, 210_407, "10.0000000000000000008100000072900000663471006037578054941961109971846019743798787768568967883977607825196231201185703931599905777478142575059197433037886640644849429868121711799908387379166244150412829868756750995686434141746550681793611205131861966618943896240489455787644047667641833775532587357347354951860849061933734563596983718732551921466222477242624543717883347751738464548920027394362249288777468527866863603589268792662265013226619720362238645296371753196982945992544809342157764932635660895084514144459078714658616303385308360807116083344675358436553861772639332131018003392263822769600788013367170840641254657935417386402298216341913768703315295200979186328829595592357419890451711003110651128306917167592947035095817938371943247284683549480620300354644733219167072295230357886515256767296936582401312899852028388653450236746397964392221394969214702319853790300669491817092375527440617300519617434647518655300519763233919845428751593401631399954846549589103520260842042473662585700329529953998722573288375417734216301300368341841451910756402387883342729738410740619538549637800720703986566506277754397127565094860842355133665432526355435908834466778493647683482193919768964669889478495995064313555004253350546805489975119958773672624840412786047757163034590102614769941894406470429098880985799816962678334361182842686682868448822202884281236246959330847329902610702114567389242482242106596503170027368847249137509967143240701004300379139052450165385396505006298195557394579572282574107772234380727251864618000068023799809016578343050862913662852515141957887710816778176532681405637400791381347201562159534216461761369721028464469459026671267142708611998648361087700086708070788962444179566342034052902509881493839921585843286431983906530972549431858299829909718452178518914824514024903078436618013692223924607337713925963196726346090209741320908646830268686074445043285549893897694034469096713668771994385825958911016145090246928421247047823348135273468030980459081922987645499106574041877923781088296407903578311922554538495247110306748622791412475501853526256867089018490510060163641548299138089441156613922625186695079198925301710220237463004161723337871601374631580609147382733241182953494764868702360306001478784532456939253458147205659139571579170101362347922398176093823321453792233329509322488534834726666996004569663642393939145703846225913100655808405967856575307494827198202928313646647573184492924078885608307859035682517224702806744796351377646716536585128582924669294614490661991865016025971646646341984400712058054579728295865527492457300181353331650316128017876683962677832160368271849351273910096592573778992422198831041928362481556198582160597097661514588719774657349950191884546665149374660959309413919715666750412567420654363528764708111677843816276478728115146425847913475216004524465641982637341960999811853198287863294419556060217960139883437273749279191037440638448809809883359269938650356441710143619563116938024283136020984637790959393897730565469348137671068053616719287831145519271524225370060450867631102895434936348458730770974369015866766144387571103926897126734763845186350992005794027171725647270803390163500850487938739440234428906134113045820347716965172324383067341885912892161807310572446527019263395794296901736201805798626432767581538184983897483354277098523840596566957528759312701709745666558685557584038574824751030824234380508632862627749049912597354204627823262114001685237334335659750554503729235983936128453818760829750724360731591601657483583183100606156215516102561196525206888380192684259672426763027183543546560246273779241091382993931586054777433017474640467119228249974977074853291381156851568528159273606168389816140447326877260674583153138706685462230838516300630417335736805855204932472364885579520458765536174767189190381340632470207855478890674857905222206937513983131378056495540233109416129395686776690749667966821978489980004259628038762534152739068889925526088322287484732816102968626537824501494121963596517968728312705427645700391575865463340376526397426309216579421970872739124941926117971527665440901756322205982451074440312877406846374402302088060948993254635839427186138706393862236284146349375731779400159192533348652054282733693891876614424177191259202440458823208175283094395076968995200336856323073492539967972113708627234748499736211348409523270445661761063622025678150433671249946408366412316135162076829893899152042582283586688780638948903814426924711285824872700925341578428708363700436109674049598033843242107974313182566168961352145648304524589571173846097681991388906122449045714205315999276475593415117900077653890706642305430445789417056602695215092626457342090761813106932499264985743312180264140759403680918673496359118816868062233499358224844160656081861889344943201138983129554746479029192959157555928334568947844496425384925571002821886125679244743681119067498184324233477269524643160774252762235700136425871241467328297353497505916746303842399464965834321189092403820740866668741887495551176128515702777592895275285347005177657747108585498688938038069255146430229932515091575887333421574734128230080567703733166022971810817143478435195653760361449219281087895458709848674178622935033568708804665250122534776115058362647031910087990300800711745386476882206939628164150616285670608200412534623673065075432992186439418896598792959049007827345972038848345472519943808031488652276546735797575295749835191324310241051142193565402061445157949150937418273530498189127534331060562331651117226125166756929017488135059142020938192391347550761181711926761678533530464655127309361658507091092415338940979503362913488702512746382865992165080528694132811117418581168428088632703706557602919674186650035098507219396416506507390128217250174876976590570486974272431465871026339427149688786981167961536728449983418894849192943127647682461594720400511874644658067366388412224134551320624417009582194788007972570791550394211208587321188144622893116068319256221706041617524897719476577347236853049855362834683801787522596267265626032036196891537491712990364588212398752732820549868667813804877024624380932181866482044984986690363378874206747756091404580350781681200213298921131020182373283659588781302258719850554269640043861824399141792032190388492932527185685998199742583536657510191683342743508418966007612590661174575017498632659156557198332770504827401593929435504757854993296481248997979284881611500522664653946248350991859994017825945563026104623456552073462723868509977203440873551311941216938665884141859464690921136787382343955179330073131903657400323283152941876610771077166116802210852900118842391081457658841265505455516018645195777771281576908662349949827384535329199272305713377900991738907124824054025898891716679914613687222985363729166728935417241412296896041901754062305961958884253826656709822495059384713140400888767648087866597599577938156160047221056348711612781375676309708654418429755207702672390095128749865590623776882776369632454963655421169264324540305354126778722472686374509546008036058673128214925466747721747405077901386127902613772013785324515446453171562723853120787064209162284222376786431728756527921684404168328077923685509106348132867687009095959882773234123236430602451518474208818116110244856522228194360376568678616774975493652276984135720556445057063569019278486175434223386451432897708039361043158186302739495273929407000857603706994193733728162976918183089956276118602031679278496381434316261052278056575730306739145792136226708358663046071933719253786845209541291406817651802041441398577035727051033216164401457096053340574085391124177060040011246283102341184331304776604873467185348551378571817545813539666822210968090219809620190267543812434648685055303034813257616719644312156863240626645489702554956293242002268503030643377497854735238578090670250625099361688404183264478068516750423421428853143102563601423328773033291834594855694813996822807290087546347896671765049713062033388864495738666912031868899409006984630063560132768397208273414595279972817048562635141838979790742816095758816471405310889788320997073721883370869057674908432941666738959167324609422653937646150833389972583767750512294629661880319923110992300310021832821199488672915265923528928004113244027430520730617738640521421629554936828868925142715318798708591068248259721059155361638314600908662787268831372246365486631925928431525948718786133341763813409969702030732388479663925164941800000970371908830385180356505060244196056322184111721875416750066292417503261000089675100735043416696995091941845336670873563704941329714966910406198803696409121737323006999639363777718210369135714359945000675418506146316505931479393976462566185809344190865032946871799735533377601453736172418999169093892438746321192592332852590147958570354522990225349211050758820561897167113265030730711698649476465810235838063146126455629750738130731717799658631895893550260731307371844897083869563463204927515165650388007337530866779630887693831078013943809926880570334614000044987319409384614725399993191139938120373436887298275675224308644460208664595998847822779515187374588205100652666416749264392337305970277584329525207398679468327983153684646699340284963915593171639997861923170543500932945858481707312184346540877472521985008050063572445578509335764434947356358021752857997870007780625170803688244313563104253424240606160590326061371886158484172142205965684074287806076019027191773148255135649040734406278783097136116183938738273842510191966843556898276286774314217746259380680960364277739314919327765766692668476822283139090876565726166748108198407784597410839837248642518881646921831086988662081596825023531107706033080125711029143889365209401323405551232990516301213698332944654830606358958436866521783585348229816668891412686911847350897811703170086417847786410514856334875192647445253091743703134868508527303346598460462145990204718510863019448853468884566567659555765620957467158812951144387855414010484267487306834135302190631168934743645406167172386121268794703546023702268816500646230074880693689514312573770244421390224234642940535251568870789195724181689190053370819485674538319638290608708445349246852597146358642131863642589959147649628243603517016792814852814534160612268961571646740301985417748067293407412370817452574357818426664247682643843912059060599737443357610735364257691733744994785179452544323018153420465196118133284675822890549907304004164566437896744584860456722230148072294348267878569156694979334024311938811238643263271653687672048558625641883412341139060404365448869725584795502821630975676842688659268385799342318874015100943537418667190509863333639757146121789948708288541345425725433374101524704323866709347187865059409491040626376569700025974270236446859151658318280091506348832626774376911746829896086152054464983695623251630172399834568757494575701300638881025813817415905738476642220138254203258032249648101571797723493359283870569483214082297248958904965445035185557920188576263716044080816001127325610259473053361123785586234548834733584396075699004288852839028561645159910889955189106692220870089209917892810252816473300630717035739444025228948729583432629209237006804056753816916460543939790868852096914654081922542145495214524006444068458641832973640599060129459547178081069320537811816894079433736123656998725197688399307064433693476346610715754157505262833298701783018105225464765651729366620737236329708850592250540390289917551557249719179072444528749245211699131426453995980732173424662697164430552296318025086494028368095658141570489089101450710742201467762133356634603545374973262912248592501463001763313235046150447019969067071718510433638444938009848936699625323885590447366973071038644946451750012710917015669345652591045357578512762064466133976641819268440555334709053546662387274546724198383290205287130868112971899828036188435130124759684054313124902349436610569873156266845722020196070384594240499726588547520055782431697620128529343169608922843442007875322190665431943155430681904419205411214769233954400029795040271053866466598284846043582098996678100869762617914840633025049679527952091804364034609712715029385706759309931510530376745745428386291498315251824668791685486004329822639402196018559902768895123296945621192205152930066891655508714065939297999966611799704267377308023133503091514878124685390935447057512487223363641832609139866743172868362873094002145156229520921607640386637627518401600417454644798837259569419062891713472233592597333792635736702985204078165357103204749639973221723675317685453490937625957532396294544806272257737078355407412953207457882287866728009587224968243747202918099547364705880937823516542294000534065404860076184226685176462835915811806752887441459375717279509027243613147916871546043531878996140017864874170670354952290230065922093599882951758935671006314525157462187032905901189443700904937678226832871864989133971320119139021184165091965902336970711266425372524471699972692388751500745738656785411776747328168400678232446172725260171718867562649794820112322863022219053502185286869886920515970895695335158927549945430704503500410981845639934796133406644733000467078404250412668678755365976673822287731783628359230937069001535427913971584017141495555987601459487174091333284150132885774309260545404270963259865765656678467476584054036833891735196514790287474591616099783706499931729150188735266636490926400167430240713615190574898234223473931434422776053166262083821084962771063161216755767072469380359472171271196677567889773967796942296952174983264792339609610291257453650361828218300736786535894757476723293038173866647382996491185187069785210435045414148913268836110746400507792245430909433340275843404610174981142592328478590189147070721239153563276216425813577574903555121622351687763400350546943190787183036082365628357627218053597684287819927019153235874295256456086752750389458128544068159751020334734285037981993846446144002578910423476184853632472168055577729305749236682318863809101579662824383031701884778487151565233079235521021044051291500785752657158449180141077539283886607483360028098577065697051216843166081372811339682583191192507039843714062578607969465251522133796951417551447899718256887436129575668779948585897451131666813398168001113328810212292172923758773607014839823754042396169885805145150826820953524070668969043088428292104616458152017869183361799568592457074191351275141297413785806384450838106602626769273903600473522764300957155139520111769552017102931455636675436293746551273093608485151838024881725945423706111455725613437103082358638049455506250045916875417762566301647453344991015439418321498706717538231130407903286630919908349471165979377610412417254752988918252199966095019610464678463328574015480023540949214222629749425931529775976839961389251748642190102643930015059763128943844474198984715129760907688924259968400765712527967983996408654368128754749890668224013180838519135630524215237770350563710190939762737470840910992752290033235839302527137652988852642199369044014177300529021534814095156808266007955220664292508045871823217352591277916680629040983724273032890884591207049780794153005145792346834810356195964241383355596588527828955604053495996805813570941003495562321809617209467516598054401043105049492174950378800148447080540868433002902740318314936897475925766949924479252412761196146126885010754653589767347667692863775924060360917049284344338487533561236555399152654133099152611121288761211827727026822315944164075091884983336154158359002760066925124709018634042069569863833085752781080351117831195091263875338601265580461516782280802718747204740600373139463314569116170678957152368510086634441788365320274125224494539461900309111392812912864597507148837315046319566922318058993013336836429465211507323424716724164922181800791855197205882213573528151619106178923866228288182677414362364471507516690637401884808457151756150080981046736927517206040407384967707122206134820175826862790024451470222508370924826176225918203574855652539286438106696586771019939616273350508088299623603445574791362830601400948472748712102013272028320776267719063955243482000815686206612744480256974770330370410007180731065263652693907339514555979582459495200381398223470724643583594175610707006157433755222647172607089270716412363520162508033397823103928290245746631236294425250279261677541282075625666807193567953561468376599362227135196266922186028992702863833515060884995154053455091886441417166616888116213682667544512193655060970361054829475598948308950429603348909391285075460613186691588098893450889930403179366668924136687210453853615049067896954617862286212546804615175921990000890109818099999263709993307860939100724545816674366931728639078731425616455892109748626298712498508283736506382002199976220020593602187320779904627197132106683902170904509755222938772529552830018849753171540853861020960135290818231146437803432584821236521792252348317596369689316964172865373973066803154908718709669259257990267347711432054174031773983689135151571130689297289191605331651708518029737514070692378043292540193962925765062543462069153604829296993946602725914084797718171660045362106331795167627436025408857831220687264108246003385039440803858830315115363967549811294703282862799874043378853795557569539492882809393333565478525445854662557277421171224533468143254479103615767942903487470421736061837798154623963207888065191700393244481678524782464575520508637236620498853247349564550800037412288440451823998111598463815546012621468715665365312473824343519901526030293886875755370569365772181229336849186884327600655481165964068610273105353485250616715781422113610860233858836228115408865850220760237008910056781082326707849092041426745676983384850548802220994100202946311847621437813274084100802265317299804387428300925597530322937526748731493332456589333454962933630162696115480534642772865250043073775310971355337939333574437935527466213299934441029404223367578351644963008069163372619386690917418887340411874798558060666797352067864003817561624739810866132278873703737751514013538696523202146461139531986369741156964644520278265135342212731533135856959636298331880314820191864863737870260015429366140326231876976810080488161732442352765225402063551159588315552172671524779410875491828966975724599479085755259681182863098683054198023893202016618138351306058996877036871581845531394713335691899454796284228646186561680297703190709099845452808512620557472947073003008364327457115379851649956650824605522422910254056583311914098138418374059607195842425482976071895001254244519513625126763988653633296748054900407300403706433592728545701929765886750869569513913082568509051374242367505524544300281453132560413506299843907328571456690001065879009618498987536440786580801157885371536756872884487544058836650854413522783263057326883821674723777239978272883803093242608067507733422420374143215404703341182800396663483610447700854993077780445107802049670998652087087733984398379258835251255319786423418156453104413723250245881577229422352788553410375755034419378913216347300268760513445720664256058045540128214334166750449017429085248604675843302550165953206510984179249875031173870883682224231508240587724989340197402996606367269036942148244273549022079296101002594519115510123951952127962683364460426716589882310967929110808154900254209593123307297341096405812077292889093365290830624146550579733611085575860797740333267537032733776997877451680684802194231700777508476994327140656476979973130517755568711575667175338572105581006079787155334163113540074333214757432254284533513990064977309510293516551771000620306105644866561368277608451327046907076045854392025374967430102203614011052887492481276182389613259664480662954874032888543699285828663501032737859398724520528312136807648544949600949041368717276455319115743404763264983264711347716973264223646704435266010360912594284305417987179222683330934518311503306634680171375589551417864918712570760203393917858984652515950337895229074846576481103846788045005690209551789006921279152983640373151127387575259227744858972397216648822771504286410689006418269958398156621424035254958639820123630463125036404437831361384265380496814963331016166231247112712448725682473403710588973766351561273800017591580079083378727758746421794592438411791189539199824807528405748427492310698280027353538248917279065147231392839806484842238931064374280785805954340834184582591079693478825211467309424271515760878893423997120158373874441202249314940469575958273060220284856104592189741788926731279233246541022544333305153352076895511999749158387717341409227806815873042025254682429736610110611252006561583259710488663365438736625493313291989069957100544709614956047496100113214511022152050302393657751701285540489798418456355607952917032371536894580986550686977530251495533388609353026345112620740524840638776050622862060587044751350207237286075859303371319660670908912106081100165257011503846904685006022633554886965349463284680116700589061894360463246780215544889961458579649273066708384907856302661411354218851423391547142863079081054019629491578629183365525487626281945499165703232407899495911885404698157183563230370344396370142106968292363411460588044291343103051223047766129653671779856513196693460089910567818186159045494048123995837847362124419095332212957523137994460555741491057248378620960164450737504601711291065572748777712013869079326209431868505749003402324030961147871746445713892655988323169494550842400331665843026259171538148460997231995074803055180708612144448289514479442681762927594042641186788034791671116605017161105575166060742111152752401490046934559427096390786577966157859411036520648532337900834274897672901568815304276220078913602637113784005835434452292453515942326995067075655111198461511824999757615597794301129928140363346077298349303415788661083595815860730024332642411427046024986118819273681256200499431343544825234357909631846977649888496613977219187193504603460810891493387212589822824567387784563228831425382366780979537625913792403915510874821148960953455544668345456482753653992977251336101087158519083142523737596966004032390637504754801212268691039745088460870304994000775445398956553131314633494882164803435799711264967372511284089852677117659362580700199403371814578783512666119965261772683882123323327323052278639694735621230194153193956794065087825992291116529849970421634649836875321615565425891645375694972918816153561227807407172966405274002387993420920740130459735187175490203297770850009633735087675089297842502610366854754338370164479169306760440610520009563832087030061991973645126960162555337480063571068497496723335320182350603659390574300454218034133384920613802696585604547029001377153912532181604042844496789885730787960069170436637550973400903857948306107329577476699155847962318135457095040759564870102040318009566893878958734299334482123862787327159464677150318562067979914818609124849343846129028918774163168944884836588452013035913318618711199431081914822764424887164366473194924906073897645272460471979391105012458974613376677081727760633722621847875858807570315149699867862187797545917057667844414777384255474196716715190122918230118474894078129636110978878609907876350161666686471167656887625596677392937864275733754909177250673512973028968055373609303818844664759586449311426688734063867479973094067755966016579209750870816832924432369612334644472245256597431835846629706123330325730405964145884273727627890921405707384792747201613918534686666765648666757402867573366094909531463677546319465590507136881714945622796005167524647024466187922643120096052311874076046154092019192237374730360110038177001348220712268727481645428182973395655057900542026894924344743812347168692278235099740039407633548609465373346134889349827493893430194349214768585954394131374986595593378019891639981014733827233996827829379233247350212550887015213071830338953656894478277658752326702746172994180174247120585648789229403982797576243376943814738288714117617298470398416080617486333619935635941333287066141012301882401947129938718882434241830152410654386855954920397289775614526958092276318639706399621329046554094242642257616144544306105353185639713989313297302751815455041439640877108831981689561033375086403713278173790832191496572861618813048831198743553908566421567954428168385297142306203913986455625376746190118390330158352004432903240340229487096007332573674826420440110426005085876646273377481088545077905679208941688901369368192461250632397380746716164795927099642855606749994121424945694967005905199753729217758936691606323812617546702919674995759042461488286399535306235772096745525999384286602497008081912773545487239263925777301725383445700908355878274138492293850279874118546854470676375683965018724000670388414200534568414864572656267611163935261592620880492769012484206113606274823817100977735618889294131893386600229737062090615365024599011723851087687044889852108498464187335943104757090353289521404934644865905268271637941272715265581627916792822142814680689613594356483708635901748587515912146313800531463684836318722010500451295554098689542298884834919770997769924179706309225327414031479467678363155873914718452542937918148835055153589001897740917269434247151852459081857296644901407568602808064285553465998536532486682446438810262512173388868877838705978332224483823242794691509432502735835693896104822554553884436440348452607170910625255287499823116167390357131352249894495474039989813763899205251483577788500476875354347665724562948093522908651058460624631992494151131615775297711655209175252403494877871803380533410763664037949261745338289982578438031463786167320454114516132442906805230370927596383541127089414256513750734275123581903625405322991107439219085796893679941732487550765636703867294006002375454540616636327711390581363654290490254043453211795425037338367758779146612990234177401131014431292231316659304982409675339847045592616214892806745524541465273327325887278666384235864015546362549571899200294282722758972777098552271597635671538403610999480960095275926867011015489800232857182119810357290193251340766687200976043528882077112826893626724732813195068519075123531683624137510979651430914828013224934921156907782446860820274533464497444526926826195034110274810404310774679147049580246251180240075740184770235681401044700750316776827801669133003289110329120903995081226355231059832603454476691354737891336214811158744781544658512056384359713098483389196117841684680459330591369908381547166272071113075847938990216163810967098779800598086185442665287528246016507039560214059916947945252326301795359346337851051674436470237372689160091390356831660347168108349229786058991053128718583472149109596475897327938765684241957726601896312077248339902960703116942317364175096113993373827339701909791287371000715076916507199859215518726961220414537105772368662528546729009776043988961919299553473725936610096023151954810682780677213304972641075170033784055407434903397657620999684351089027594910961113689665134575960824641242694235308598541308238625904972305735247901190755908935878770506496811690120986372000975986018881472690821401494574753599820257758445345601844544976786169288754059527661949801723742385686055790743107687662279958536747622603403365699070627860732713532748693148005007646846379586301973235347964541666476519164936405400921281048383658350291290906650747258621800052648380479181262360541387480927436076439587295600252489962296848656901403777802766278005173939847082771608453229736924389796011947224708719736749349605229081407503640808291231355449395334589578544765156657362926392002630086223933792737797513103957369327012060867709753896968760462334720207254053886011080362700912300578293835262474710888519788085530079678323724262745890871987606926987223036393729631101939643035750751624521839783229742027382552449182037287556458316763778782550386111208513692997474598177018844220871482328930489201367451731633810757948677897324868865657116677479680765065103062092437055041177281874713256959890639145004816138543826868848824505714303002081157318930431602267737580636330983790620052494641667701239257081277231339622806000567534524164564177997534018967559572685792111432608214037544747741576204448351560479998390367985433348667435372873662703150330517668007718878870240987719193069244656922026377991250039720294361454686789237648972062605726769712105504380160899859464107721123388362222833286227782985672825161522708970666651632985529860176421727604627721202193262939950592753551204057315875921574478986327757965582597567801637858894904516753631102377043031639191587915833450034165395310896997329163485695387638828027521435050444248959042746527288985298329767024800879844688006594760860011513826104856817554188939743120161662393390127779858262796709381450055452195504606879091923409736502947602176831279809163836263390990996858009971407891549811813022287498510916236448527751681683540303312116760141072517283678907281486156261523211979861310016737913052315009586066587152205943093174082147074147538455742599939157659447144700968935778817323687237644743862567250149361968259193911968664598833847849396115429503840408485028717213753226645155172470911988485299103316221839367618738326330518761507720730530258647744353694481718619782829440023828904216834928373198658196107708584580156219679420789082729261652836272940810084571371769518483102626296233898485728476301129134332175122423603614054711887897886279870764336823955546097995461391758699475004165141537902796094915443653730537329947889694425796220084745602690184984488783358847118565508859946130617409788619239076434994595558458919581975358195975840583380141208759285809709500787356457173043760273888218492463788281412373360853407583765928012269953011656571596074801605280694599954320860394319829507310448524625081573278242316913005083900246263493050997786683079858824126715298743109218643293889645874395778267001582148714397561401017807939262052328284676179290553232354034414340713170508589851627357649809035613262215980686166234244112650621425128754968670860214904908955634663396275437716106483135568996541777868529368603617335292917743065551462706518310548316625997781296578999798868979169707702344340092143494838424803029673807570030838887280714874254497255715925837014925035835817834205942290464074843304081074059037773938053742836208059809501444266462332824807309705746510222293243832868518798103521070842041743852579869139476809161138963367174566641207556434996863558470648382082981276955121520291606644653620385347945514766304183563368070507649441611509918665550259856426364693488018710740160267735539436393400771179947827737525151411478885944457861284566537770555493703954992706800433631802946049414909049674862352041328403576080372542332200135222940230528764197811753390086955930791298962100820555927467058858950235624547144182569012061459009759268888809347698165063972302082156048947619235423335123352349614406381491908071576282451344178407232022695811406612883800169142581540007492013987177327291413678351054472994676704251549908689104979070855228544782587857521548693446093191359448033270977103575891642459613946390586912153530900597212195434622878455069003941127854864263487364797734209659381388900370630893372741939691951570196759296890509600893637368213100050731110461653915201050547329559988798995897260862665154850252901037301400249442742188928953927353480738106674716851739923342733302419683052019034773373224537696342483036716676634121749270507919171622064380760785873023151443700678137757171053582156587598434947145677019025668973133586845515640375192327406150179396776632510586355846343938201729027635734232485181507515151719197880644619713866047496181031405247385868751211397536023718387815837248124118966029482590058291569611453283456124879451546403008991267381828633174639751889221823191918582946459105622777861086278535893234676627625557311473571534401400963053558763787303750464472229226696475962938012262735903490896722577160175371157595885634122558460515282071689066844270508283671625381330790970118297828075700235488953142949465500840136867645245414571733280702772853585232967706620006122142055712302706981873633535058165169028493038159367647250237489977161968792173835008781906679915349977229684873790132343390204325660859363432820207246763885944741362097227395084761195271327686969081870418645028909669762267994836719753014141652428689847101077527619805509440230135096094229455457488036563141133534584315083717267269927132155526902615375813799911805579198240770703910013405589221990861110116836183063209257775204246564358643654663657265539281115597458152017869183354509568526847073594227369707477164338041385476176688833207860282191529377942917258280547058452978231112101903201127319122158604012453296513243998270528484261808396782456491720354066555222006462520258727934354432302625333143890531690403838374574929209441855805839887833151079281674011463233585315425618270373127070395456259598651970447732930264369665486763955921451998886023189862730027750851352532746498047993213236738232354317915234293028551066559822805694386721818919249552165162824702982514797140803653981321351230023486193213805358245620660035148816319854147510672750447122028258810457236175160841093963654765069258281130250366385278333296032833074898780973478906859468052421078277031820420989565021005041772145880118427509078500332614272026789883543787939438470248971079265628721317222173986721702279167498840424238637860571685531202330233941205938864973962671263068408493921707294687617381657310073081522475041854441880875429215966405055294286084178003357919830557880458076631168497351733325899963265689746717776687031767852799087460390695889563432595026426614740563194139116966665965206660283299608578034538060113486347032806757998533397786654729858557960712877450587184799533381675834773250088336575804672839822441842384228865696481867837985078325664204663544263248252795478100438858813993614397341891096811208972882001654036215051648556970009968427089902686518195447315570470571692092202397958041821426280574978343232303004413957332067011722619806675759240749417190819695626459230281778995556088859561218622007008460263785088400443494444035880440726503910611186396561796127712344770282337408759270419790360820084183462766879511178522551724563320693525408311081296630839791240642101099843119927572391349008761275169727604125521197534142897561510367809663347067944558318294670696481584337982409375639926128323327686742281957454765812028368889539156894798227742664682458248529370061625367560790034803189397709023511052113951384236957515556313399662451936118312618757644830686467959247668429153701705298693618218111115784811234641782227140218267785986236771474754628520267118724430780473320102299112930922737671396831809711177568371715062182607146861725028341697758719449604265991398828621729339647736990875406616958100214319521950307568747798883704969840905225552318552526090727987426434685580474638782327312919177737564517492837109176717693508941010931282199474676115219551838497921811331088475012905123427436623108673270297026759702133513289495970934405235503088453078104842010754070397862039810544562356955517440195208706586399229855232991690720224384744041901251781301383109842587109567542616064637814288204109212657393916182284629158790126154990147929410346165734150107370765977154970392102130568130198169984722346860981456434930443557867117376590760026975917055480845123875690635368784781045941507599067719143416244205897822273589182689669662475993118531537459636990874596616959639214332635850426994338885647673859393913120484601296409872607329840645701549883984103943445345885433647557438092772687454231455752506247355906850937942343535356326171734468162784470281338598560181254997649419668609719065348443486570835728604605130220906685018350833666182586362342535897308976665512497656163647671089201906911736542896802621360903846284225001996447518086672414596818972830242652755289140073123074665420789455329103043494845795803095931808173060454374842034811063326780676192704153361707795590730939875732552869158131109339803094992127164428365296298123386312922896447598349573144981925619335442135952531537168036178229129302885076648154197499013197240939094892553863522239348052378148276641141217434385888652911505741494710347601863353176956594910305005583775551622357519682453429118426204976868465289584034135206610630380966736466716301847126446808849855960533770240857301091801440745393110702077307397003497311921825538569612400975372848876702924777915615479040200859265017819311743155736854617205377826568938140777337089173767510671284347189687559418056790705126795416572838290820928446469638862873794652151523234578862244667646345475581751927793941732924869850616315632508472256637097535316587571389046899639516786719683759149114108256939195138146594757134020389919584738268221199240812904991397436231716669627621693619457411936252448619978282441794270220328669004990806945416351303288796049928044135345201623541334775036146452747932720014287752129208544375878753820488559766446703874664924259450818861002450825122302589612953557377877372948684093752025253151529803678111213470893042585118587524579956473677522910465466585235745115645280633372053755585689176639771507340920716810478522974544559068436487522763936457152631760088868016808707052959233371929023765554116258442457952636367368909943057088581819505284557498170473233343206423423988453158213923739754806031767924889088197490702589065393561305081407795240810944791379596791554330884144411037614140443098678032116970092272527839679193341080740403834729574896039941553963387141066831083708162051744274751872900233943392129694868380142302259303050559656950092878326845192766191254173150412975587758077856698508495146427305913488483804645202623081343869959229216637085871396671429709791010359090094267720667836257996309947774520524747326775200754654326859254374420024807222144745721525286065879293199501649115464998850731490351656562119074715291679909153477173296723277000173720701581668384393101297977229911592791385494401688999055361791403793111774517236148106857047772398324728824836032305999793984598935259850229864637099868197607990598232795443918430439657717810885231998055611190406061831885162670235980299139320722168628571734439002783403025328966720493597237491734853074787163790563190413125032767537798183783963472515067599879015158899847945988535308495679407310681796527204429397560299417798725511968402077912458917103376144830722918040578554161164842867410070093350637849498904430439220316996985884672563450520328209734986627588378319154242703493608601872838277034728321016837721253142263403602696972783732452332046316221613377616682546311811090437480931081076472027795895533942649350778109092890792745225213981557547232172869812773196296236078195748312391309642679917748395351510396888744611768575967085941300482875834394089092986218846174590690188775361717855783532487630955637441615300718707336540235952516147248896939956862153608255597835044940298917056720144406153314176995159002555946924069117008947964781434579511053863550590239310371169624377644391836563884712731358985855365961283830328682855982913989445327303952397465966825040298107056712774297086246095384839468812039166108556411595963345522456444254434642715347148709659863257904674646932547387086180412484241834606600686820066250872602882859686234031244729683517040120086065092775092344254150332712687027685460051937685662632939610959750451633729110676934907079107654427979655293804863173705254880709719414459256671579154711370315973469874548575858473040312096566840079568244723990026988317345593687034902552098613224089280339213261086840594890249421601269735761554595511146819143336054205168093266948648729240803436090501268423642542655139038161766057272071040175846473700202909861846479823802966388506994136223646639554184419951178221554911816149778526962976495363086917804090871017226934356765101836562426793718083814734562714894520705459138419686259619144152534211869061328000358084804068571716943002624189423880122947309118901512981995668136161390039068568355523980135268218420940787711561168167106630321480335925390056921057617981623513632774055058243892930019426473176780824908705514769220183589903670749123403808922974662009069424201531760242039018201745065635961097287237885313865566356176572841206820954982069880336835992065207519693388430019834713099495889213512591842154585763687730449550247090908058527263251598095597642669937738296433499497544837327658020491687986393360676187682153307097595094669115361480849789476543084236461066551803805621413821154865853509279258834441256203415431370080425475831871829260033646347306181752386253947524910922395689393808873483659938701305523181880252855110301791503746221684090625425224690559544684172856625964895296281357196160269485058460414031988957691099595989006315399957470949612985560478168608451334336097142458564996372933366993694449642619410747836645905313476928352640129009025165882129010337373993989103345308940442310548025026068027737210952408620476918446258957860964616534777200466472605244900699628596367430226943534065186168093194128838066572507405809809292869265375110314832503864983885171352545059308241039704985361315367597969845060525590058882869535024112768800426196075778384290393297042498003086739928089332535612926155077628003106414829078374944532211995251229156785375326746996473397659807918705062060215983747965460206485687069019752409079746914525696922993841999162962192391055950757799151896053282254076768512099403460104490486950871531252930124401664213055144330701813410196502032707168497643333328553523289837142937517992631413733755864977097371291594178753506216656906652577850530358439827071802426272402079086958919690516169183778139572372970108594837988212944692737804803914022905617608522120237543194161643876870959198525728714684131302815594855702913186888410000685341006236522156752359726446472700662901657032405070894886145953463928095521745677347885663055759533888411758376447001226477711160866171563890261231400567205745242572281699307763464510647526965892495397721708118457543878044649290198208540804507721320939264020555402587053353542185598233888935828389316848342783238919327482265880087809508799147530072234423657334065281739913063833216980882273716028690896861087153335893096166627175035307292829396364746696919195022964674700878539778804711987041879082089199647010906787799332768973920097662673698730330577446008262858675191203944240036892584327622517382174908177710664417175146196293020386266566515025747186734300209282131823467399601653336374235361005622785151159244875549938367504358144289667213035970828627334621508745047629579934239177401495514353617280617916443623039717969661425423918972167662646644730084475143768722998295379365487952217840365183157323166650640816528931430412466016753521752457039847359063420967477049804041161316774567172648561352101908296027365494659026001316136611984943169062172838465853830039261753357282765551273085516585086300924284528410989289540002526714022993907609244478244124760121535316295971378374339543198389843106157572265952907620179559343633180027062019246264367041005740883152241955685401804837156423208123451274923406593703000003507300031835430289710515636364882290920509847376631511127347561258862726455650818846422450692444301382243142570312597390654636254876189919381428266370187223968784738115933016854991263380420415761825791532614702136793789525823484676893710560542766100858171517817460812138083390456639853155414563714273339799887311178974539828668311630881635922022886882308270629815262731237890854272906773882641642332119945222283401522779763857295770101391516022662794996231434546706054366925094739828362132357095404457668180563970443132212032503121395778405511583490074409759685228813134772199526508015691214842790055879389508421444526643245192452721251319844387010575821796240788345791092946698953914960479816140366407877334303583742163422053687059688552251265825485709011920033008472292277097860531590530756473829892011852016497853350211465486916235930938556971540787441021173813292680890963396188766905309678838318887428701794601186338970795683824240722881590578214374261751615781939622615650573902420221702024017569418559873608894850650943140842582581675601493247163588549269655798345767764947296661020318615284907499092657431743182709862962651652960130851937190671628435119918759590450712273182481685952483342168408413732435564965171741183062034765864597369367827961247235257349840760883550932140313481666852683249359417561070699806553368239554650979955423917593547650101364615922409904893930944534771514266420787924429169302305440731979510652913546942323277175060822293061582866859594088422387204643715462257811516546084719569370956181275700439608874081440754133010862611208849761919532833475848784629413940127747855162497381978726986006415491658380982191266937130529127968815064508117087024675491924465976512648486265100415012413857612966096177991476029722431789474129292314576559252646689280084872440672339210928286819366410056242431511805316757428463492599009682650988922123999110328391912088366399194134232747621517995255813757637905194423937269265929150319145267904302937929148635155253389912805767206532489679445655272955463064894713882441896331031256612303435171969360064920366590775416976056286382112206887221082592711851601777849575368431135933723336988782366598729536048357778040063880164580499497682626428911892403098221678193817190563736442230001623483014773776434441357453416353636088818007408243875515019266376675324108745449381483589372310663287946035920317026874884134561445705509155912033318800313201082769129853207181664184543144079423611122746761216996337074666586379465944153140090983574828031530935078831509218176733885327278356486333044024820700625949375696131218834794901396633521709365055655222005652520251518934288814202028210048456711359956073383700267790862436896929175762047399434632144855152437181887186455173395932077903062908917864371152566587488355865144038380910749265477818315929146674947134742019736152379517986653621778547957374786412191556350935062793509881420939839930552551468028217549056779777416695966391933294976592984205996156282665022171441701760200486017816322762129347135376977931930507280567615443165300613804235577518543756228748181600608452573636918419285957615583214301799150146373076331994913621153722052498869867739715877431414476525871737195432808397438556424790863464786857529641403519728672029531725468738620765521457066245258492831852365769856520405694336501818462085548004986586845377130292931966665680888557696086685034388752812937658697732693339367509469244336162023459075223477584452646018527178768596516794228383827478284730052391853476765785638568657410974781629870512912821667498577174237862285564465798636646867593485685100719815416550312190607841744531359794235374135641904633531332165216122703458616601474221073415330768079518089523613804664885703450459893299185029832583771395512319707262109335275194951085274054867893899298644483617583800920020688372187454186905914100843810217678673790875931415970975893435880629456513728135274926022901826809216623963790278070499630441545827018067106864410664366137046541847123449808823401360292951568665859355859320130219813185810299990792729916221942237618864362331746697218886844691871096696026898933844788397987573611686919947350971512793840767233950981747953933914480798620965267450864933802862797606052268215075559757187601890407176392705305254618277808926328062039585364479226816769064032597672696638902539414005008667446388873762057751234733636236075279748285126709394644955491269904970556054232060101611746923856897007178762765318641164400444596043964824000087998400799975447279857570246695789244932492128885597372858944193016391346449161333687368128455049969750954724652687994347560748561992811914215588419353754616119977006691709760894566924140558199679079698079625244424589725073766498090275132629603706928583733050192970756747933886407008366303695133363633813609066893842508814966830208098154894503209539898206813081781999043406191295077340785195701145281690422063301840776054851062098334665094926452363822616510786620248158163258239293749977572314795908145642764117249153467777296556692398665908927859770433523911026067590329115071995757155161309111967921018908080462063532285778143792481108512388087462650595910128522782168747317735681591394694381691719683394649037891306252910886900679070796260544245962852638262769008191116974539172568306469561588873091458745124174580630798683740187022035710000524960194777137853471954458494785573112548715243193308721159109361737895191895846246244100840822127651481280628479661819164921744400787955047170382829250484556179409380232625368216890849963706734750731286223554704635157812179855090836689426613872972186244127894821555742876158070173038357574649062029306463656688819356868256139401130869360290911097647290996690348069072167428637723600595184765416991365294540424180325960040965426372785460992347686930363951876311961993438854148393572749571512021181759392745910473988595313296136350994848894053124125883429626539209593406807300811946437307712579508284473524578709073747252571091898396937085412127396250359313978269756392254783250518527571618600902539268213026340738547800720784176559136087688138389862059348554740071767134653089025343109320622294898662883569732240485373388416816834593041294796674972649742332112655214125162449348978288994702429859892111724208216690375771882411424129944769582497322200725640126603324342090251594021289497493734428002983294746147982198046638001414405812952092897855945370489912871458126130268955885447497747572229583907289205456331770462619111128833911280488592651636193129970357482722153092772403144228787612481975373585975089632373396654597901456840904067252226930995265080156912228617901280503901652577405038455195849942201234474039333713757126795189934836228398909678430888073721000470861112384836121892008709298279254606241216917605073950125172946147173809938471670440173201005568029150669875271095783966971642199441943204921683245787317528564589510747764547723657384293382197068967993327689739281968527465914409939821049452371558116581178050888720344087355123094931620973877750781287532117816542271320534669097865488782475947921341126084123247365529651026319014339503111489478306454252589543698564766656939384678148399761150437907468984949867763044606643705839457723147165280638394053809466889666140595961880233253110041603301386690042618069387824512429203055005747801362304992315975430083476413758825365205391823369057492658423993191658257044090147201220338721105082443056250223711877036588081032870537399129990332082102021947209399719597437448337490779871085096826882481124629768234130971930591836468385712672309985237020865664989877550597885710521759965739915688234042762929708142660352198209204193703758243704200009608220088244802802946705506823120112089583020015286482139098887465800685938786161042954073590882068867026826770944123607491524828982875943663171087342956894820097742862970460053023086482510896990849081616726650812212521581133946469318912862702107051399174167651484925636612823292366691960617896841614761258695137454125669832543603576146791732935804850715824133413999614877396495303308107268203776139844362872664702141240689485291084316148786276953963220281064494557686981474951523322058863040735653589694447674319473835497211903105628318253117696104181034547966414386502470917171675346262326650987164423983197068247093240048548492541791281320300660095736006863097662454998728340407427897715693869212004209829319309446797615965859115289317868132792608108412732976555870167658418517591608510893637449051100786373117155994556119550541687909921259980284275820586828967340151702795379685437955218485392480117071569875351285784696700648839975903633780723148404580642381683846483323002917239326554977871649488632010427551294882616783432622729236785836054759208098307983694602732620884858750052215435475160381823959482698031291742084754933971269891038556009260859684192823126162790448080583077533387005553813650539705029911315691192972797956052460590077391450704262193308785959919952235190565340242244596203615825452985011622155505761615912430704722119412979386658111608588815719158223036239829630592449638310291708631754548548156391788304165273559803989395026303494658361801399192392731840773859832042124463483332618508326828344774137945544655303646363263262905695684341830728320659627637002611504823764693086258707165954235202083540339770217091827975535642677374347554106562823369721684564467330346652706073539625277310590022716369206799959781871534015031769536789021784780106341498966897640598849529449522617990656633714975285806275108937103490517641763791540050494914459504531581491156391569531263282733685872876622443177256132913031619508587656528147682506143909995909581043777187490272406162288896076747954298414484115570995451696139610434862354957248240110958904009726034588506913945412916984257544548643655393467264080471103132295138503884950385353129506713470411092581550942492032576677504547765290574664144310443713216937790274943891501908412667374655273108552985287913166120001711692016386397349035215876228564473679126710480134065369211894859829053224444303342443168516232832687718777539240875598991967951636908359814866074323381276341959614711913493878404694293483528070700024443370230534669097055488783285947927894026143836447908911594971095522336969252456420197434423796645156549471734600192703861753613241957879691816705276532018008341363876716411278038342630157017934428053203295365149987814764889115170490947970467626539355401507324153716730798822242169282404550469881328275920095410872867428943093684382152519777587930786050170072056547663814583739902712033195679502072583468861319566637927056405144313286812440909993293280938960756544543694555347539453662617128329815057801317106991985665527069557106332969586630023246433211541732225029844247771574554721329257964096166473275123006803618551912928903407653012909642418287746006337488657679246784880335742411136255941331829066120454501696054965434108285450384587598499828146348428031770695899113332600931326676575072756023162079891774927007051835764981705461252519697406029246394056142185991893892518134421915833239434001478849421557529735363520591889037386182140214258285949750321142727930498824166729299917317629247582326152999977992299718729927448542339780925292006501157259152431058287932630420105936822972125089045528310314388623860928377134449041923486200503724432683892336613420263263124395686332000746431206792442981811239234482276223788713717477294820943382871394784129611535579473073773204161336157949159037329247239696959881242253919304518765671119957607191695225444418451544208719052299262375923295720901990250208111357893813348733701474286683415927819084951253673055598424806026665734834558186995289501657053465079194632220670343208100204193711850062777836381278310988632630004656933041568090678350625172982589074142370574695491229728978290533701633856684949095833028672080561725933111624991315795520973738430861019801835280188601049717079552425342927070628736342720690718758366540701127420380260335460368971689357650473154618495707028391933958358499021063151091674593934238812901573196594316089089276410704315337410079570431643090927960227444437259744379144673850208432036897541535767546975484685576910637939886805333969928531026349633149781661582013120404419395679406500682680156212381321532670835947304526120471195796287880936219716600599421057354731622738057766835325678209563671706219412526677653992758551334103627140342925977120634491797773065359734975773588271439653270910844765207687363398055006921490562985645123169362520841199749654917640859750539923729912495942203794074054517973896114372454640708337230453968797130306053885866090361373322288498042825332108710522197365751995218343156567922724759996795316780837382624620181892143655217697262481126088578239306061978495164004224992438455531189944523828495247839306747237691400672991746043224889001446489912353058202493829642685749748441132710814226668409470782526183310988268210993240711938490479450263362916396602547309083179702656935375178111906020818345599446944873967198361201505086123696283806636182632289261954642283787163782463198520415105725777462185574905880631643514557955982396399439815334902318737611100593261015390575240055044684500825628957521323513443233972333510148234934248937902475334912444547703253484099605895306413728288364919324120766659498976520440686344110245730593236148479448951154885455510267645143354570804534694321264908323510746743947787269924864966316271112478067131650410897208739164680526398584690227121491066805487707929946242162509993678841023477453305544825081267908239456964979066481309504169916488027240041039784373462847798511833966457697194765043662361897408493266409188724324427391352208261305103277876439018675595150947915865526034377096912831500906766666351576662989347633284063462876877512180395360841516783657810831286077754703307648800099595980906324236247550468852709274659654398592855027275980748203324808651065758724617404394026479985640157869325517610862202158846040455498968064040609390869545456102863650617059220607138907525774058484462932208620783098448316195879758382505793180802718755304740592273139397785568519038673523332929062321554467126955650855215422782468447320462060616204832607463968627922115324091249368230369258996360256056878330198592804799094523672570165420307505324806398455737415947210566119616143588506907465412857854257006481838758983922706753777631459368346280252761150300045467730421856346838082756226634081662362043127495402460208081387893548729831292631464763027329343540597026220242938604129741297588745808056776853316750365182420223160024840756225969881656334023072638799961013160645219753771499760130647817107895135689945734777696186477116296941750202169927649746341531691707946494542312290335041923048881491644821574777876330397674606626938920304334174769521990402642012664043125242792358709410472355635297626281208480158997161346874169066554938424649939672414451018161504265350688814683168213617640743920449769676101004052518326877916855589043377760294738428682119620007288550166325805703564831983439971041203736475764001929371417557287999771319987919011971063008928573381250827769382451701380318582560898291304174531867988231898692911088105490820759966477015694940032823954379697984847151662109890125199919139319272267805376827028929206963255775265627555727210757036617889041322790275227391504650262692309290500015353550139636306270698487063355422276534423716463247719815555060321550967926113816227635726861485114520514542128582333370909233675193026444264640642807419849547601630883166741036818153435045115258910556956086067490383214243487249607633971430279140015459174140686584680247110590248787371263956978502009314368284679751390593837654403112655068406161122487966214641302553235772234445535433454371634434781954356515776544293567363071462922950312606947844722415386974061021463947195321920287429474534608218273034786283806555182720652162749834681024305597321099935622017514160358568859263057619293816235573728553720929757860460804630193321324759224136308939632311350654843290958992947726843924314278901259938082465436542335472536062800078090480710631474466745607647385110591204498279960935157644509853565039675541861046620935524331513271408670769819714005359316448769787783805068022626119086897683682668921513097185769103390498848953539524667209674552608038420633149628571661619921120741290298745740908586242349134805369026728858953232616393416809188192963611745968866969316689412681873656215050271475957470439312980996938127072217956357175302850296065937694119033016491300450070024095637300270299424359724762483495338518807580529248982815355743619818266940338129157077785329407765497610674128257133757139917270973247157756549136394597141109833984107589255378252223942176237873795664651541358329026279794139154226666302652663354220236523396052362904886502434386172152922266591591815983485606449719010592442997201231274450204597504961837294342719378599746345249591741772094850125982136146445538932653594287147789013044871918708335270245850878237243000058911299726092827588444731046747052526208177988413419694570219220588184907352563656908321177865723528578084029060564672551138519405360526669780792686905213451647442409910725930195705964780114279499120943441992485322132426431404999525785503784648083630297561116707806153941036001673427615147191297847540810411811374747564510202828942845744189896272047056075636310288289613623435564973263633156699062535961468996249367873969247652310153636103398088532822605649495711410329973834010861889498033194432183069332857830929007071453964269231074858102781207925308992201311829023837644117732561471285309388704415437209370478605352355308698333309155643113316271331178077213720501834856566778194757673472294829407882947530734822537786885093050654346841954556253686461909356803375065910713107887489280966152456872987357536084953579183077570485005891421653611936237868619845604440586900409341603725008512897577475467955025948390736211355699515236865589465476864054839462907139112454155923332899902329381011197368011896048827254044336111803457807411466128444341760743510023575941214460065051594691969510886922549151995197275056295203822286354701805827794533032929440599657990456887705057678116834870863116324854366656174735761190095507829869113151808930491461267391297533268907552746248729990944442917586330550036418005331322848515046021486917985530953749331679110818279909256347174151759284789109491580086373378866997747681579503903183485518888718221895435819247655955153750191899118646281980491166022388610803744458314073760658071302988448849094884527573449200837387727628328321416977724894578296540654398519955836531598031437542094181633056242860811891033388200303832623574876874450379557506553973308831157110444529705037120315838604874131223354594140626806678893940778015861079936235827420556029526978868695515805129193016675656532748474439911117404001168376329632224607753243929744519760756129822872681388142210632094035752055733443707173527735279183391040560758469103712068843698826477667420946772720615631838602249723180472481752299583864926213178928539927439713339782391392011661667306931172492992669686241394144795876717642559130547279987980248700620263094644394169363986940402281157741758535441902672522124319951250311556385935163111199984312000857239199700876718087978134519601024136469319641060808733734359476974571240469408288271534423270971351765838491069130349729086174434684188165626112226197621266498353524325017071438655350083663685762149540435479817962874443462156625505625373101190887120837073609617369766518064883414390438260952988255672193118516957379314312151679240580289189280630812453740474329038308294248606287662317136727085952316482165269987704037888106736681771304614118871907481734366183782731462422856389047993132236737504164311287814232719117617743969511470122635378115973840855362761783801051232589574316565125470742641864758040961198172747713372004110685237415335660478744510356656044245561902634614123974988447172394877368793383246019787619780067331898612721087375761814119432516586835900130206691265880890511416103654696543257657543644691747166694089216916292873938257052838139990827073835526371911389984392838857974914607571714828902605753013712271424781678065513269586170753315153855159800081954990745790334786692054658897696585969039013318255013096120619984697641779748540203811715853876614270358189860251427728288802327428020179594991734314423972261258228577449871954793835598623903866477525193045479255903861228806137182127748357363320052006131473255804506627820200313163903849791516933102804901235524520243273142313785594245448907714585060194624047771888834724107395989385403503406361880997974117081556365442163735523689912265578209716761707612531539355"},
		{"NearZeroHighPrecision", "1/1000000000000000000000000000000000", 33, 0, "0.000000000000000000000000000000001"},
		{"RepeatingDecimalHighPrecision", "10/3", 500, 0, `3.` + strings.Repeat("3", 500)},
		{"VeryUnevenLarge", "1234567890123456789012345678901234567890/987654321", 50, 0, "1249999988734374999015820312399.80224608362747192395465660095056679248811791509390"},
	} {
		b.Run(tc.name, func(b *testing.B) {
			prec := strings.IndexByte(tc.output, '.')
			if prec == -1 {
				prec = 0
			} else {
				prec = len(tc.output) - prec - 1
			}
			b.Run(`FormatDecimalRat`, func(b *testing.B) {
				runBenchmarkFormatDecimalRat(b, tc.input, tc.prec, tc.floatPrec, tc.output)
			})
			b.Run(`big.Rat.FloatString`, func(b *testing.B) {
				runBenchmarkBigRatFloatString(b, tc.input, prec)
			})
			b.Run(`big.Float.Text specific prec`, func(b *testing.B) {
				runBenchmarkBigRatFloatText(b, tc.input, prec, tc.floatPrec, false)
			})
			b.Run(`big.Float.Text auto prec`, func(b *testing.B) {
				runBenchmarkBigRatFloatText(b, tc.input, prec, tc.floatPrec, true)
			})
			b.Run(`strconv.FormatFloat specific prec`, func(b *testing.B) {
				runBenchmarkStrconvFormatFloat(b, tc.input, prec, false)
			})
			b.Run(`strconv.FormatFloat auto prec`, func(b *testing.B) {
				runBenchmarkStrconvFormatFloat(b, tc.input, prec, true)
			})
		})
	}
}

func TestAppendDecimalRat(t *testing.T) {
	nr := func(v string) *big.Rat {
		t.Helper()
		r, ok := new(big.Rat).SetString(v)
		if !ok {
			t.Fatal(`unexpected invalid rat:`, v)
		}
		return r
	}
	for _, tc := range [...]struct {
		name   string
		rat    *big.Rat
		prec   int
		fprec  uint
		result string
	}{
		{`zero`, big.NewRat(0, 1), -1, 0, `0`},
		{`zero with prec 0`, big.NewRat(0, 1), 0, 0, `0`},
		{`zero with prec 1`, big.NewRat(0, 1), 1, 0, `0.0`},
		{`zero with fprec 128`, big.NewRat(0, 1), -1, 128, `0`},
		{`large number of significant digits and low floatPrec`, nr(`167799489101319075473056204671783778853657134707047539294845260401563392904348371258261089013578519182257097872193610745706583844946648101377424220402028127973435142353538392012404014583293616437643479367806052697389425577464078629771715619668690597930943267429627621783884748619556745929406687221617630927221977523030206169253281815948844802020451378652852186126951605975505987475417601383602609629635489217436650997436403671727230317874258195589978899496592287214148673658061621155098795264424354138119844472860079119051773834993895061949548115153938668364392661166473324042571899225251782385908190525066977985960801245264858364157283882098415894489/933415641675522910645025538928310040422604579825451645663381920942988552796813328884687254915740536381772529706932205910407394536667421732335412855380411158539802138847055390214687853958373327630799145693082091096315273713300074746536989321232605329054257842557903501459118692070246154756363612496489368247414340716077187244639253515768692736`), -1, 53, "179769313486231569995921046774104434048386446944329178485314420765176628523124396354701868608387085564428793419425520689308708363451136055357897278026477617073498977686288394835618163294045594434929537447290627480669417384648879122776218333598953852832103282504751611691208117720159985926376802466863339536384"},
		{`rounding negative to zero preserves sign`, big.NewRat(-2, 10000000), 2, 0, `-0.00`},
		{`special case round away from zero 1`, big.NewRat(1, 20), 1, 0, `0.1`},
		{`special case round away from zero 2`, big.NewRat(-1, 200), 2, 0, `-0.01`},
		{`not special case round away from zero`, big.NewRat(1, 2), 0, 0, `0`},
		{`required base formatted value three extra from target`, big.NewRat(5, 101), 1, 0, `0.0`},
		{`required base formatted value three extra from target - more precise`, big.NewRat(5, 101), 6, 0, "0.049505"},
	} {
		t.Run(tc.name, func(t *testing.T) {
			b := make([]byte, 123, 2048)
			for i := range b {
				b[i] = byte(rand.IntN(math.MaxUint8 + 1))
			}
			old := slices.Clone(b)
			result := AppendDecimalRat(b, tc.rat, tc.prec, tc.fprec)
			if s := string(result[len(old):]); s != tc.result {
				t.Errorf(`unexpected output: %q`, s)
			}
			if &b[0] != &result[0] {
				t.Error(`expected same array`)
			}
			if !bytes.Equal(result[:len(old)], old) {
				t.Error(`unexpected prefix mutation`)
			}
		})
	}
}

func FuzzFormatDecimalRat_variant1(f *testing.F) {
	add := func(signbit bool, num uint64, denomSub1 uint64) {
		f.Add(signbit, num, denomSub1)
	}

	add(false, 0, 0)
	add(true, 0, 0)
	add(false, 1, 0)
	add(true, 1, 0)
	add(false, 1, math.MaxUint64)
	add(true, 1, math.MaxUint64)
	add(false, math.MaxUint64, 0)
	add(true, math.MaxUint64, 0)
	add(false, 3, 6)
	add(true, 3, 6)
	add(false, 7, 2)
	add(true, 7, 2)

	f.Fuzz(func(t *testing.T, signbit bool, num uint64, denomSub1 uint64) {
		denom := new(big.Int)
		denom.SetUint64(denomSub1)
		denom.Add(denom, big.NewInt(1))
		rat := new(big.Rat).SetFrac(new(big.Int).SetUint64(num), denom)
		if signbit {
			rat.Neg(rat)
		}
		float := new(big.Float).SetRat(rat)

		isFloatDifferent := func(v *big.Float) bool {
			return v.Cmp(float) != 0 &&
				nextafter(nil, v, float).Cmp(float) != 0
		}

		s := FormatDecimalRat(rat, -1, 0)

		t.Logf(`result string: %s`, s)

		if s == `` {
			t.Fatal(`unexpected empty string`)
		}

		r, ok := new(big.Rat).SetString(s)
		if !ok {
			t.Fatalf(`invalid result (rat): %s`, s)
		}

		f, ok := new(big.Float).SetPrec(float.Prec()).SetString(s)
		if !ok {
			t.Fatalf(`invalid result (float): %s`, s)
		}
		if isFloatDifferent(f) {
			t.Errorf(`invalid result (float): %s: float-converted vals do not match %v != %v`, s, f, float)
		}

		{
			v := new(big.Float).SetRat(r)
			if v.Prec() < float.Prec() {
				t.Errorf(`invalid result (float): %s: rat auto precision was not preserved %v != %v`, s, v.Prec(), float.Prec())
			}
			v.SetPrec(float.Prec())
			if isFloatDifferent(v) {
				t.Errorf(`invalid result (float from rat): %s: float-converted vals do not match %v != %v`, s, v, float)
			}
		}

		decimalIndex := strings.IndexByte(s, '.')

		n, exact := rat.FloatPrec()

		if n != 0 {
			if decimalIndex < 0 {
				t.Fatalf(`invalid result (float): %s: missing decimal`, s)
			}
			// note: behavior has changed - it now uses the float precision to bound the accuracy, even when exact
			// --------
			//ratStr := rat.FloatString(n + 1)
			//var trailingEdges int
			//for i := len(ratStr) - 2; i >= 0 && (ratStr[i] == '0' || ratStr[i] == '9'); i-- {
			//	trailingEdges++
			//}
			//if trailingEdges > n {
			//	t.Fatalf(`invalid result (float): %s: too many trailing edges`, s)
			//}
			//if n-trailingEdges-2 > len(s)-1-decimalIndex {
			//	t.Fatalf(`invalid result (float): %s: expected get least %d decimals got %d: %s (%d trailing)`, s, n, len(s)-1-decimalIndex, ratStr, trailingEdges)
			//}
		} else if exact && decimalIndex != -1 {
			t.Fatalf(`invalid result (float): %s: unexpected decimal`, s)
		}

		for i := range len(s) {
			if i == decimalIndex {
				continue
			}
			if i == 0 && s[i] == '-' && (len(s) >= 4 || (decimalIndex == -1 && len(s) >= 2)) {
				continue
			}
			if !isNumericByte(s[i]) {
				t.Fatalf(`invalid result (float): %s: non-numeric byte get position %d`, s, i)
			}
		}

		{
			_, _, approxDecimalsRat := approximateDecimalBufferSize((*bigRatInfo)(rat), 0)
			_, _, approxDecimalsFloat := approximateDecimalBufferSize((*bigRatInfo)(rat), 0)
			if exact && max(approxDecimalsRat, approxDecimalsFloat) >= n && r.Cmp(rat) != 0 {
				t.Fatalf(`rat values do not match despite format indicating exact: %s != %s`, r, rat)
			}
		}
	})
}

// validating fixed decimals are equivalent to formatting with a very high precision
func FuzzFormatDecimalRat_variant2(f *testing.F) {
	add := func(signbit bool, num uint64, denomSub1 uint64, prec uint8) {
		f.Add(signbit, num, denomSub1, prec)
	}

	for i := 0; i < math.MaxUint8; i++ {
		prec := uint8(i)
		add(false, 0, 0, prec)
		add(true, 0, 0, prec)
		add(false, 1, 0, prec)
		add(true, 1, 0, prec)
		add(false, 1, math.MaxUint64, prec)
		add(true, 1, math.MaxUint64, prec)
		add(false, math.MaxUint64, 0, prec)
		add(true, math.MaxUint64, 0, prec)
		add(false, 3, 6, prec)
		add(true, 3, 6, prec)
		add(false, 7, 2, prec)
		add(true, 7, 2, prec)
		add(true, 3, 757894378, prec)
		add(false, 3, 757894378, prec)
	}

	f.Fuzz(func(t *testing.T, signbit bool, num uint64, denomSub1 uint64, prec uint8) {
		denom := new(big.Int)
		denom.SetUint64(denomSub1)
		denom.Add(denom, big.NewInt(1))
		rat := new(big.Rat).SetFrac(new(big.Int).SetUint64(num), denom)
		if signbit {
			rat.Neg(rat)
		}

		n, exact := rat.FloatPrec()

		t.Logf(`input: prec=%d rat=(%s, %d, %t)`, prec, rat, n, exact)

		s := FormatDecimalRat(rat, int(prec), 0)
		rn := int(prec) + 70
		rs := rat.FloatString(rn)
		expected := new(big.Float).SetPrec(1024).SetRat(rat).Text('f', int(prec))
		t.Logf("result string: %s\nexpected string: %s\nrat string: %s\n", s, expected, rs)

		expectedVal, ok := new(big.Rat).SetString(expected)
		if !ok {
			t.Fatal(`unexpected invalid expected value`)
		}
		actualVal, ok := new(big.Rat).SetString(s)
		if !ok {
			t.Fatal(`unexpected invalid actual value`)
		}
		var truncIndex int
		if prec == 0 {
			truncIndex = len(rs) - rn - 1
		} else {
			truncIndex = len(rs) - rn + int(prec)
		}
		truncVal, ok := new(big.Rat).SetString(rs[:truncIndex])
		if !ok {
			t.Fatal(`unexpected invalid trunc value`)
		}

		checkTrunc := func(v *big.Rat) {
			t.Helper()
			if d := truncVal.Cmp(v); d == 0 {
				return
			}
			delta := new(big.Rat).Sub(v, truncVal)
			delta.Abs(delta)
			for range prec {
				delta.Mul(delta, big.NewRat(10, 1))
			}
			if delta.Cmp(big.NewRat(1, 1)) != 0 {
				t.Fatalf(`unexpected truncation: %s != %s (delta %s)`, v, truncVal, delta)
			}
		}

		checkTrunc(expectedVal)
		checkTrunc(actualVal)

		if s == `` {
			t.Error(`unexpected empty string`)
		} else if expected != s {
			var ok bool
			// can be represented exactly, and equal length, and able to round up (based on the next digit in the exact string)
			toNines := func(v string) string {
				return strings.NewReplacer(`0`, `9`, `1`, `9`, `2`, `9`, `3`, `9`, `4`, `9`, `5`, `9`, `6`, `9`, `7`, `9`, `8`, `9`).Replace(v)
			}
			if (!exact || int(prec) < n) &&
				(len(s) == len(expected) ||
					(min(len(s), len(expected)) == truncIndex &&
						max(len(s), len(expected)) == truncIndex+1 &&
						rs[:truncIndex] == toNines(rs[:truncIndex]))) &&
				(prec == 0 || s[len(s)-1-int(prec)] == '.') &&
				(prec != 0 || strings.IndexByte(s, '.') == -1) &&
				rs[truncIndex] >= '4' &&
				rs[truncIndex] <= '5' {
				n1 := int(s[len(s)-1] - '0')
				n2 := int(expected[len(expected)-1] - '0')
				roundedToEvenOrIsResultIsEpsilon := n1%2 == 0
				if !roundedToEvenOrIsResultIsEpsilon {
					roundedToEvenOrIsResultIsEpsilon = s[len(s)-1] == '1'
					if roundedToEvenOrIsResultIsEpsilon {
						for _, v := range s[:len(s)-1] {
							if v >= '1' && v <= '9' {
								roundedToEvenOrIsResultIsEpsilon = false
								break
							}
						}
					}
				}
				if n1 >= 0 && n1 <= 9 && n2 >= 0 && n2 <= 9 && roundedToEvenOrIsResultIsEpsilon {
					nd := n1 - n2
					withinOneDigit := nd == 1 || nd == -1
					if withinOneDigit || (n1 == 0 && n2 == 9) || (n1 == 9 && n2 == 0) {
						ok = true
						// exclude the epsilon case
						if withinOneDigit && (n1 == 0 || n2 == 0) {
							allZero := true
							for i := len(s) - 2; i >= 0; i-- {
								v := s[i]
								if v < '0' || v > '9' {
									continue
								}
								if v != 0 {
									allZero = false
									break
								}
							}
							if allZero {
								ok = false
							}
						}
					}
				}
			}
			if !ok {
				t.Errorf("unexpected output: %q != %q", s, expected)
			}
		}
	})
}

func ExampleFormatDecimalRat_roundUpEdgeCase1() {
	rat := big.NewRat(5, 101)
	const floatPrec = 53
	float := new(big.Float).SetPrec(floatPrec).SetRat(rat)
	for prec := -1; prec < 19; prec++ {
		fmt.Printf("prec=%d\n", prec)
		fmt.Println(`ours: `, FormatDecimalRat(rat, prec, floatPrec))
		fmt.Println(`float:`, float.Text('f', prec))
		if prec >= 0 {
			fmt.Println(`rat:  `, rat.FloatString(prec))
		}
		fmt.Println(`---`)
	}
	//output:
	//prec=-1
	//ours:  0.049504950495049505
	//float: 0.04950495049504951
	//---
	//prec=0
	//ours:  0
	//float: 0
	//rat:   0
	//---
	//prec=1
	//ours:  0.0
	//float: 0.0
	//rat:   0.0
	//---
	//prec=2
	//ours:  0.05
	//float: 0.05
	//rat:   0.05
	//---
	//prec=3
	//ours:  0.050
	//float: 0.050
	//rat:   0.050
	//---
	//prec=4
	//ours:  0.0495
	//float: 0.0495
	//rat:   0.0495
	//---
	//prec=5
	//ours:  0.04950
	//float: 0.04950
	//rat:   0.04950
	//---
	//prec=6
	//ours:  0.049505
	//float: 0.049505
	//rat:   0.049505
	//---
	//prec=7
	//ours:  0.0495050
	//float: 0.0495050
	//rat:   0.0495050
	//---
	//prec=8
	//ours:  0.04950495
	//float: 0.04950495
	//rat:   0.04950495
	//---
	//prec=9
	//ours:  0.049504950
	//float: 0.049504950
	//rat:   0.049504950
	//---
	//prec=10
	//ours:  0.0495049505
	//float: 0.0495049505
	//rat:   0.0495049505
	//---
	//prec=11
	//ours:  0.04950495050
	//float: 0.04950495050
	//rat:   0.04950495050
	//---
	//prec=12
	//ours:  0.049504950495
	//float: 0.049504950495
	//rat:   0.049504950495
	//---
	//prec=13
	//ours:  0.0495049504950
	//float: 0.0495049504950
	//rat:   0.0495049504950
	//---
	//prec=14
	//ours:  0.04950495049505
	//float: 0.04950495049505
	//rat:   0.04950495049505
	//---
	//prec=15
	//ours:  0.049504950495050
	//float: 0.049504950495050
	//rat:   0.049504950495050
	//---
	//prec=16
	//ours:  0.0495049504950495
	//float: 0.0495049504950495
	//rat:   0.0495049504950495
	//---
	//prec=17
	//ours:  0.04950495049504950
	//float: 0.04950495049504951
	//rat:   0.04950495049504950
	//---
	//prec=18
	//ours:  0.049504950495049505
	//float: 0.049504950495049507
	//rat:   0.049504950495049505
	//---
}

type approximateDecimalBufferSizeTestCase struct {
	name        string
	r           string // rat input
	f           string // float input
	p           uint   // float prec
	e           int    // exponent, for confirmation
	bytes       int
	significand int // only tested against if not zero
	decimals    int // only tested if significand is
}

func (tc approximateDecimalBufferSizeTestCase) val(t interface {
	Helper()
	Fatal(args ...interface{})
	Fatalf(format string, args ...interface{})
}) *big.Float {
	t.Helper()
	if tc.r != `` {
		r, ok := new(big.Rat).SetString(tc.r)
		if !ok {
			t.Fatal(`invalid input rat`)
		}
		f := new(big.Float).SetRat(r)
		if tc.f == `` {
			t.Fatalf(`TODO fill in rat float: %d %q`, f.Prec(), f.Text('g', -1))
		}
		f1, ok := new(big.Float).SetPrec(tc.p).SetString(tc.f)
		if !ok {
			t.Fatal(`invalid input rat float`)
		}
		if f1.Cmp(f) != 0 {
			t.Fatal(`invalid input: rat float cooked`)
		}
		return f
	}
	if tc.f != `` {
		f, ok := new(big.Float).SetPrec(tc.p).SetString(tc.f)
		if !ok {
			t.Fatal(`invalid input`)
		}
		return f
	}
	t.Fatal(`invalid input: neither r nor f are set`)
	return nil // unreachable
}

var approximateDecimalBufferSizeTestCases = [...]approximateDecimalBufferSizeTestCase{
	{`zero`, ``, `0`, 53, 0, 1, 1, 0},
	{`negative zero`, ``, `-0`, 53, 0, 2, 1, 0},
	{`float64 0.1131213778389989`, ``, `0.1131213778389989`, 53, -3, 20, 17, 17},
	{`float64 -0.1131213778389989`, ``, `-0.1131213778389989`, 53, -3, 21, 17, 17},
	{`float64 1.131213778389989`, ``, `1.131213778389989`, 53, 1, 18, 17, 17},
	{`float64 -1.131213778389989`, ``, `-1.131213778389989`, 53, 1, 19, 17, 17},
	{`float64 0.1`, ``, `0.1`, 53, -3, 20, 0, 0},
	{`float64 0.2`, ``, `0.2`, 53, -2, 20, 0, 0},
	{`float64 0.3`, ``, `0.3`, 53, -1, 20, 0, 0},
	{`float64 0.4`, ``, `0.4`, 53, -1, 20, 0, 0},
	{`float64 0.8`, ``, `0.8`, 53, 0, 19, 0, 0},
	{`float64 -0.1`, ``, `-0.1`, 53, -3, 21, 0, 0},
	{`float64 -0.2`, ``, `-0.2`, 53, -2, 21, 0, 0},
	{`float64 -0.3`, ``, `-0.3`, 53, -1, 21, 0, 0},
	{`float64 -0.4`, ``, `-0.4`, 53, -1, 21, 0, 0},
	{`float64 -0.8`, ``, `-0.8`, 53, 0, 20, 0, 0},
	{`float64 1`, ``, `1`, 53, 1, 17, 0, 0},
	{`float64 10`, ``, `10`, 53, 4, 17, 0, 0},
	{`float64 14`, ``, `14`, 53, 4, 17, 0, 0},
	{`float64 3e20`, ``, `3e20`, 53, 69, 22, 0, 0},
	{`float64 1e20`, ``, `1e20`, 53, 67, 22, 0, 0},
	{`float64 0.9999999999999999`, ``, `0.9999999999999999`, 53, 0, 19, 0, 0},
	{`float64 -0.9999999999999999`, ``, `-0.9999999999999999`, 53, 0, 20, 0, 0},
	{`float64 0.5`, ``, `0.5`, 53, 0, 19, 0, 0},
	{`float64 0.6`, ``, `0.6`, 53, 0, 19, 0, 0},
	{`float64 0.0001`, ``, `0.0001`, 53, -13, 23, 0, 0},
	{`float64 1e-20`, ``, `1e-20`, 53, -66, 39, 0, 0},
	{`float64 0.0000000000000001`, ``, `0.0000000000000001`, 53, -53, 35, 0, 0},
	{`float64 epsilon positive`, ``, strconv.FormatFloat(math.SmallestNonzeroFloat64, 'g', -1, 64), 53, -1073, 343, 0, 0},
	{`float64 epsilon negative`, ``, strconv.FormatFloat(-math.SmallestNonzeroFloat64, 'g', -1, 64), 53, -1073, 344, 0, 0},
	{`float64 max positive`, ``, strconv.FormatFloat(math.MaxFloat64, 'g', -1, 64), 53, 1024, 310, 0, 0},
	{`float64 max negative`, ``, strconv.FormatFloat(-math.MaxFloat64, 'g', -1, 64), 53, 1024, 311, 0, 0},
	{`float64 11312137783899.23 - all digits significant simple non-int case`, ``, `11312137783899.23`, 53, 44, 18, 0, 0},
	{`float64 1131213778389989 - all digits accounted for int case`, ``, `1131213778389989`, 53, 51, 17, 0, 0},
	{`float64 11312137783899890 - trailing zero int case`, ``, `11312137783899890`, 53, 54, 18, 0, 0},
	{`float64 11312137783899810 - trailing zero int case`, ``, `11312137783899810`, 53, 54, 18, 0, 0},
	{`float64 11312137783899850 - trailing zero int case`, ``, `11312137783899850`, 53, 54, 18, 0, 0},
	{`float64 113121377838998900 - another trailing zero int case`, ``, `113121377838998900`, 53, 57, 19, 0, 0},
	{`another trailing zero int case larger exponent`, ``, `1.131213778389989e+27`, 53, 90, 29, 0, 0}, // literal 1131213778389989000000000000
	{`enormous exponent high precision`, ``, `9.56283812312389124199992231211153e20_000`, 1000, 66_442, 20_003, 0, 0},
	{`tiny exponent high precision`, ``, `9.56283812312389124199992231211153e-20_000`, 1000, -66435, 20_304, 0, 0},
	{
		`rat test case tiny value`,
		`1/992312746765329556771115994874643748994002060757333344377234732474`,
		"1.007746804885585521320519773044058318888139776710584024413150570298e-66",
		220,
		-219,
		136, 0, 0,
	},
	{
		`rat test case large value`,
		`399231274676532955677111599487464374899400206075733334437723473247482813884328482399530450430054300354050330453238487235729359352003250325994593456034050034598346783496345094358354883400224475757555543593459/3`,
		"133077091558844318559037199829154791633133402025244444812574491082494271294776160799843483476684766784683443484412829078576453117334416775331531152011350011532782261165448364786118294466741491919185181197819.8",
		687,
		685,
		209, 0, 0,
	},
	{`float64 1.999999999999999`, ``, `1.999999999999999`, 53, 1, 18, 17, 17},
	{`float64 1.999999999999999e1`, ``, `1.999999999999999e1`, 53, 5, 18, 17, 16},
	{`float64 1.999999999999999e2`, ``, `1.999999999999999e2`, 53, 8, 18, 17, 15},
	{`float64 1.999999999999999e3`, ``, `1.999999999999999e3`, 53, 11, 18, 17, 14},
	{`float64 1.999999999999999e4`, ``, `1.999999999999999e4`, 53, 15, 18, 17, 13},
	{`float64 1.999999999999999e5`, ``, `1.999999999999999e5`, 53, 18, 18, 17, 12},
	{`float64 1.999999999999999e6`, ``, `1.999999999999999e6`, 53, 21, 18, 17, 11},
	{`float64 1.999999999999999e7`, ``, `1.999999999999999e7`, 53, 25, 18, 17, 10},
	{`float64 1.999999999999999e8`, ``, `1.999999999999999e8`, 53, 28, 18, 17, 9},
	{`float64 1.999999999999999e9`, ``, `1.999999999999999e9`, 53, 31, 18, 17, 8},
	{`float64 1.999999999999999e10`, ``, `1.999999999999999e10`, 53, 35, 18, 17, 7},
	{`float64 1.999999999999999e11`, ``, `1.999999999999999e11`, 53, 38, 18, 17, 6},
	{`float64 1.999999999999999e12`, ``, `1.999999999999999e12`, 53, 41, 18, 17, 5},
	{`float64 1.999999999999999e13`, ``, `1.999999999999999e13`, 53, 45, 18, 17, 4},
	{`float64 1.999999999999999e14`, ``, `1.999999999999999e14`, 53, 48, 18, 17, 3},
	{`float64 1.999999999999999e15`, ``, `1.999999999999999e15`, 53, 51, 17, 17, 0},
	{`float64 1.999999999999999e16`, ``, `1.999999999999999e16`, 53, 55, 18, 17, 0},
	{`float64 1.999999999999999e17`, ``, `1.999999999999999e17`, 53, 58, 19, 17, 0},
	{`float64 1.999999999999999e18`, ``, `1.999999999999999e18`, 53, 61, 20, 17, 0},
	{`float64 9.999999999999999`, ``, `9.999999999999999`, 53, 4, 18, 17, 17},
	{`float64 9.9999999999999999 - rounds up to 10`, ``, `9.9999999999999999`, 53, 4, 17, 0, 0},
	{`float64 99.99999999999999`, ``, `99.99999999999999`, 53, 7, 18, 0, 0},
	{`float64 99.99999999999999`, ``, `99.99999999999999`, 53, 7, 18, 0, 0},
	{`float64 99.999999999999992 - doesnt round up`, ``, `99.999999999999992`, 53, 7, 18, 0, 0},
	{`float64 99.999999999999993 - does round up`, ``, `99.999999999999993`, 53, 7, 17, 0, 0},
	{`rat 99.999999999999993`, `99.999999999999993`, "99.999999999999993", 64, 7, 22, 0, 0},
	{`float64 1.999999999999999e+7`, ``, `1.999999999999999e+7`, 53, 25, 18, 17, 10},
	{`float64 -0.1999999999999993`, ``, `-0.1999999999999993`, 53, -2, 21, 17, 17},
}

func Test_approximateDecimalBufferSize(t *testing.T) {
	for _, tc := range approximateDecimalBufferSizeTestCases {
		t.Run(tc.name, func(t *testing.T) {
			f := tc.val(t)
			if e := f.MantExp(nil); e != tc.e {
				t.Errorf(`unexpected (binary) exponent: %d != %d`, e, tc.e)
			}
			bytes, significand, decimals := approximateDecimalBufferSize((*bigFloatInfo)(f), 0)
			if bytes != tc.bytes {
				t.Errorf(`unexpected bytes: %d != %d`, bytes, tc.bytes)
			}
			var knownExtraRequired int
			if f.Signbit() {
				knownExtraRequired++
			}
			if !f.IsInt() {
				knownExtraRequired++
			}
			if bytes-knownExtraRequired < significand {
				t.Errorf(`unexpected bytes vs significand: %d-%d > %d`, bytes, knownExtraRequired, significand)
			}
			if f.Sign() != 0 && f.Prec() >= 53 && significand < 17 {
				t.Errorf(`unexpected significand: %d < 17`, significand)
			}
			if tc.significand != 0 {
				if significand != tc.significand {
					t.Errorf(`unexpected significand: %d != %d`, significand, tc.significand)
				}
				if decimals != tc.decimals {
					t.Errorf(`unexpected decimals: %d != %d`, decimals, tc.decimals)
				}
			}
			c, ok := new(big.Float).SetPrec(f.Prec()).SetString(f.Text('f', bytes))
			if !ok {
				t.Fatal(`failed to parse formatted float`)
			}
			if c.Cmp(f) != 0 {
				t.Error(`unexpected result: formatted float does not match input`)
			}
			uniqueIdentifiable := f.Text('f', -1)
			minUniqueIdentifiable := len(uniqueIdentifiable)
			if minUniqueIdentifiable > bytes {
				t.Errorf(`unexpected result less than min unique: %d > %d: %s`, minUniqueIdentifiable, bytes, uniqueIdentifiable)
			}
		})
	}
}

type approximateDecimalBufferSizeRatTestCase struct {
	name  string
	value string
}

var approximateDecimalBufferSizeRatTestCases = func() (cases []approximateDecimalBufferSizeRatTestCase) {
	m := make(map[string]string)
	for _, tc := range approximateDecimalBufferSizeTestCases {
		var vr string
		if tc.r != `` {
			if v, ok := new(big.Rat).SetString(tc.r); ok {
				vr = v.String()
			}
		}
		if v, ok := new(big.Rat).SetString(tc.f); ok {
			vf := v.String()
			if vr == `` || vr == vf {
				m[vf] = tc.name
			} else {
				m[vf] = tc.name + ` - float variant`
				m[vr] = tc.name + ` - rat variant`
			}
		}
	}
	k := maps.Keys(m)
	slices.Sort(k)
	for _, k := range k {
		cases = append(cases, approximateDecimalBufferSizeRatTestCase{
			name:  m[k],
			value: k,
		})
	}
	return
}()

func (tc approximateDecimalBufferSizeRatTestCase) test(t *testing.T) {
	r, ok := new(big.Rat).SetString(tc.value)
	if !ok {
		t.Fatal(`invalid input:`, tc.value)
	}
	f := new(big.Float).SetRat(r)
	ri := (*bigRatInfo)(r)
	fi := (*bigFloatInfo)(f)
	rb, rs, rd := approximateDecimalBufferSize(ri, 0)
	fb, fs, fd := approximateDecimalBufferSize(fi, 0)
	t.Log(`r`, ri.Valid(), ri.Signbit(), ri.Sign(), ri.Prec(), ri.Exp(), ri.IsInf(), ri.IsInt())
	t.Log(`f`, fi.Valid(), fi.Signbit(), fi.Sign(), fi.Prec(), fi.Exp(), fi.IsInf(), fi.IsInt())
	if ri.Exp() != fi.Exp() {
		t.Log(`unexpected exponent:`, ri.Exp(), `!=`, fi.Exp())
	}
	if rb != fb || rs != fs || rd != fd {
		t.Log("unexpected rat vs float", rb, rs, rd, `!=`, fb, fs, fd, "for", tc.value)
	}
	if rs != fs {
		t.Error(`unexpected significand:`, rs, fs)
	}

	// nasty constraints on the deltas (didn't feel it was worth it to model the behavior beyond this)
	if rd == fd {
		// special case is float normalised the exponent, because the value was able to left shift
		if rb != fb && !(rb > fb && rd == rs && rs == fs && rb-fb == 1 && rs == fd) {
			t.Error(`unexpected bytes:`, rb, fb, rb-fb)
		}
	} else {
		// special case: bounds of <-3 switching case, where the exponent decimals are dropped as known to be 0
		if rd < fd || rd-fd > 2 {
			t.Error(`unexpected decimals:`, rd, fd)
		}
		// special case: because of the non-normalised exponent, the "trailing zeros on the lhs" calc is off by one
		if rb != fb && rb != fb+1 {
			t.Error(`unexpected bytes:`, rb, fb)
		}
	}

	// simpler sanity check, for the above constraints
	for _, v := range [...]float64{
		float64(rb) - float64(fb),
		float64(rs) - float64(fs),
		float64(rd) - float64(fd),
	} {
		if t.Failed() {
			break
		}
		if !(v >= 0 && v <= 2) {
			t.Error(`unexpected value:`, v)
		}
	}
}

// float values from the test cases (as rat)
func Test_approximateDecimalBufferSize_rat(t *testing.T) {
	for _, tc := range approximateDecimalBufferSizeRatTestCases {
		t.Run(tc.name, tc.test)
	}
}

func Fuzz_approximateDecimalBufferSize_ratInt64NumDenom(f *testing.F) {
	add := func(n, d int64) {
		f.Add(n, d)
	}
	for _, tc := range approximateDecimalBufferSizeRatTestCases {
		if v, ok := new(big.Rat).SetString(tc.value); ok {
			if n, d := v.Num().Int64(), v.Denom().Int64(); d != 0 && v.Cmp(big.NewRat(n, d)) == 0 {
				add(n, d)
			}
		}
	}
	add(math.MaxInt64, 1)
	add(-math.MaxInt64, 1)
	add(math.MinInt64, 1)
	add(1, math.MaxInt64)
	add(-1, math.MaxInt64)
	add(1, math.MinInt64)
	add(-1, math.MinInt64)
	add(1, 7365733-math.MaxInt64)
	add(7365733-math.MaxInt64, 1)
	f.Fuzz(func(t *testing.T, n, d int64) {
		if d == 0 {
			t.SkipNow()
		}
		tc := approximateDecimalBufferSizeRatTestCase{value: big.NewRat(n, d).String()}
		tc.test(t)
	})
}

func Fuzz_approximateDecimalBufferSize_ratBytes(f *testing.F) {
	add := func(n, d string) {
		f.Add(n, d)
	}
	fromInt := func(v *big.Int) string {
		return string(v.Bytes())
	}
	toInt := func(s string) *big.Int {
		return new(big.Int).SetBytes([]byte(s))
	}
	for _, tc := range approximateDecimalBufferSizeRatTestCases {
		if v, ok := new(big.Rat).SetString(tc.value); ok {
			add(fromInt(v.Num()), fromInt(v.Denom()))
		}
	}
	{
		b := make([]byte, 1024)
		for i := range b {
			b[i] = byte(1 + ((len(b) - i - 1) % math.MaxUint8))
		}
		huge := string(b)
		one := fromInt(big.NewInt(1))
		negOne := fromInt(big.NewInt(-1))
		three := fromInt(big.NewInt(3))
		negThree := fromInt(big.NewInt(-3))
		add(one, huge)
		add(huge, one)
		add(negOne, huge)
		add(huge, negOne)
		add(three, huge)
		add(huge, three)
		add(negThree, huge)
		add(huge, negThree)
	}
	f.Fuzz(func(t *testing.T, n, d string) {
		dv := toInt(d)
		if dv.Sign() == 0 {
			t.SkipNow()
		}
		nv := toInt(n)
		tc := approximateDecimalBufferSizeRatTestCase{value: new(big.Rat).SetFrac(nv, dv).String()}
		tc.test(t)
	})
}

func Test_approximateDecimalBufferSizeWithFixedDecimals_sharedCases(t *testing.T) {
	for _, tc := range approximateDecimalBufferSizeTestCases {
		t.Run(tc.name, func(t *testing.T) {
			f := tc.val(t)
			size1, significand1, decimals1 := approximateDecimalBufferSize((*bigFloatInfo)(f), 0) // baseline
			size2, significand2, decimals2 := approximateDecimalBufferSizeWithFixedDecimals((*bigFloatInfo)(f), 0)
			if significand1 != significand2 || decimals1 != decimals2 {
				t.Error(`expected significand and decimals to be identical to the base func: got`, significand2, decimals2, `expected`, significand1, decimals1)
			}
			if decimals2 == 0 {
				if size1 != size2 {
					t.Error(`expected value without decimals to have unmodified size: got`, size2, `expected`, size1)
				}
			} else if change := float64(size2)/float64(size1) - 1; change < 0 || change > 1 {
				t.Error(`expected size increase 0-100%:`, size2, `expected`, size1, `:`, fmt.Sprintf(`%.2f`, change*100), `%`)
			}
		})
	}
}

func approximateDecimalBufferSizeTestCaseFloat64s(f *testing.F) []float64 {
	m := make(map[float64]struct{})
	for _, tc := range approximateDecimalBufferSizeTestCases {
		v, _ := tc.val(f).Float64()
		m[v] = struct{}{}
	}
	v := maps.Keys(m)
	slices.Sort(v)
	return v
}

func Fuzz_approximateDecimalBufferSize_float64(f *testing.F) {
	for _, v := range approximateDecimalBufferSizeTestCaseFloat64s(f) {
		f.Add(v)
	}
	f.Fuzz(func(t *testing.T, val float64) {
		if math.IsNaN(val) || math.IsInf(val, 0) {
			t.SkipNow()
		}

		bigVal := big.NewFloat(val)
		bigValCopy := new(big.Float).Copy(bigVal)

		bytes, significand, decimals := approximateDecimalBufferSize((*bigFloatInfo)(bigVal), 0)

		if bigValCopy.Cmp(bigVal) != 0 || bigValCopy.Mode() != bigVal.Mode() || bigVal.Prec() != bigValCopy.Prec() {
			t.Fatalf(`unexpected mutation of input: %s != %s`, bigValCopy, bigVal)
		}

		// we don't really want to format huge values, so we parse the exponent form as verification...
		// WARNING: big.Float differs from strconv - it rounds as part of the formatting
		strVal := bigValCopy.SetPrec(bigValCopy.MinPrec()).Text('e', -1)

		eIndex := strings.IndexByte(strVal, 'e')
		if eIndex == -1 {
			t.Fatal(strVal)
		}

		exp, err := strconv.Atoi(strVal[eIndex+1:])
		if err != nil {
			t.Fatal(err)
		}

		decIndex := strings.IndexByte(strVal[:eIndex], '.')

		var digits string
		if decIndex == -1 {
			digits = strVal[:eIndex]
		} else {
			digits = strVal[:decIndex] + strVal[decIndex+1:eIndex]
		}

		mantissa, err := strconv.ParseInt(digits, 10, 64)
		if err != nil {
			t.Fatal(err)
		}

		if digits[0] == '-' || digits[0] == '+' {
			digits = digits[1:]
		}

		{
			v := mantissa
			if v < 0 {
				v = -v
			}
			if digits != strconv.FormatInt(v, 10) {
				t.Fatalf(`unexpected mantissa: %s != %d`, digits, v)
			}
		}

		// lhs = zeros after mantissa, before decimal
		var lhs int
		{
			delta := exp - len(digits)
			if decIndex != -1 {
				delta++
			}
			if delta > 0 {
				lhs = delta
			}
		}

		// rhs = zeros after decimal, before mantissa
		var rhs int
		if exp < -1 && mantissa != 0 {
			rhs = -(exp + 1)
		}

		// calculate the number of decimal places
		var decimalsExpected int
		if decIndex != -1 {
			decimalsExpected = len(digits) - 1
		}
		decimalsExpected -= exp
		if decimalsExpected < 0 {
			decimalsExpected = 0
		}

		expectedBytes := len(digits) + lhs + rhs
		if strVal[0] == '-' || strVal[0] == '+' {
			expectedBytes++
		}
		if math.Round(val) != val {
			expectedBytes++
		}

		t.Logf(`%s (mantissa=%d, exp=%d, lhs=%d, rhs=%d, dec=%d, bytes=%d): %d %d %d`, strVal, mantissa, exp, lhs, rhs, decimalsExpected, expectedBytes, bytes, significand, decimals)

		const (
			maxBytesDelta       = 30
			maxSignificandDelta = 30
			maxDecimalsDelta    = 30
		)

		if expectedBytes > bytes || expectedBytes < bytes-maxBytesDelta {
			t.Errorf(`unexpected bytes: %d < %d or delta more than %d`, bytes, expectedBytes, maxBytesDelta)
		}

		if len(digits) > significand || len(digits) < significand-maxSignificandDelta {
			t.Errorf(`unexpected significand: %d < %d or delta more than %d`, significand, len(digits), maxSignificandDelta)
		}

		if decimalsExpected > decimals || decimalsExpected < decimals-maxDecimalsDelta {
			t.Errorf(`unexpected decimals: %d < %d or delta more than %d`, decimals, decimalsExpected, maxDecimalsDelta)
		}
	})
}

func formatDecimalFloatUnsafe(b []byte, f *big.Float, bCap, decimals int, panicOnRealloc bool) ([]byte, int) {
	// TODO: potentially lower (accuracy+) bCap and decimals by handling the mantissa value?
	//exp := f.MantExp(f)        // get and remove exponent
	//defer f.SetMantExp(f, exp) // restore exponent

	b = slices.Grow(b, bCap)

	{
		old := b[:1] // bCap > 0, so this is safe
		b = f.Append(b, 'f', decimals)
		if panicOnRealloc && &old[0] != &b[0] {
			panic(`floater: format decimal float: buffer reallocation`)
		}
	}

	if decimals != 0 {
		b, decimals = trimTrailingZeros(b, decimals)
	}

	return b, decimals
}

func Fuzz_formatDecimalFloatUnsafe_float64(f *testing.F) {
	for i, v := range approximateDecimalBufferSizeTestCaseFloat64s(f) {
		f.Add(i, v)
	}
	f.Fuzz(func(t *testing.T, i int, val float64) {
		if math.IsNaN(val) || math.IsInf(val, 0) {
			t.SkipNow()
		}

		var buf []byte
		if n := i % 10; n != 0 {
			if n == 1 {
				buf = make([]byte, 0)
			}
			for j := 1; j < n; j++ {
				buf = append(buf, byte(rand.IntN(math.MaxUint8+1)))
			}
		}

		t.Logf(`input value: %g (~=%.2e)`, val, val)

		f := big.NewFloat(val)
		fCopy := new(big.Float).Copy(f)
		t.Log(approximateDecimalBufferSizeWithFixedDecimals((*bigFloatInfo)(f), 0))

		old := buf
		bCap, _, decimals := approximateDecimalBufferSizeWithFixedDecimals((*bigFloatInfo)(f), 0)
		buf, decimals = formatDecimalFloatUnsafe(buf, f, bCap, decimals, true)
		if f.Cmp(fCopy) != 0 || f.Mode() != fCopy.Mode() || f.Prec() != fCopy.Prec() {
			t.Fatalf(`unexpected mutation of input: %s != %s`, f, fCopy)
		}

		if len(old) >= len(buf) {
			t.Fatalf(`invalid buffer len`)
		}

		if !bytes.Equal(old, buf[:len(old)]) {
			t.Fatalf(`unexpected buffer content`)
		}

		s := string(buf[len(old):])
		t.Logf(`formatted string: %s`, s)

		// note: can't verify against big.Float, it accepts finer-grain precision of certain values
		if parsedStrconv, err := strconv.ParseFloat(s, 64); err != nil {
			t.Error(err)
		} else if parsedStrconv != val {
			fv, _ := f.Float64()
			t.Errorf(`unexpected result: %g (feq=%v) != %g (feq=%v)`, parsedStrconv, fv == parsedStrconv, val, fv == val)
		}

		if decimals < 0 {
			t.Fatal(`unexpected negative decimals:`, decimals, s)
		}
		if decimals != 0 {
			if len(s)-1-decimals != strings.IndexByte(s, '.') {
				t.Fatal(`unexpected negative decimals:`, decimals, s)
			}
			if s[len(s)-1] == '0' {
				t.Fatal(`trailing zero(s):`, decimals, s)
			}
		} else if strings.IndexByte(s, '.') != -1 {
			t.Fatal(`unexpected decimal position:`, decimals, s)
		}

		rounded := strconv.FormatFloat(val, 'f', -1, 64)

		if val2, err := strconv.ParseFloat(s, 64); err != nil || val2 != val {
			t.Fatalf(
				"unexpected result: ours=%d baseline=%d:\n%s\n%s\n%s\n%s\n%g\n%s",
				len(s),
				len(rounded),
				fmt.Sprint(`approximate buffer size = `, fmt.Sprint(approximateDecimalBufferSize((*bigFloatInfo)(big.NewFloat(val)), 0))),
				s,
				rounded,
				big.NewFloat(val).Text('f', -1),
				val,
				big.NewFloat(val).Text('e', -1),
			)
		}

		if len(s) <= len(rounded) {
			if decimals == 0 {
				if strings.IndexByte(rounded, '.') != -1 {
					t.Fatal(`unexpected rounded with decimal:`, rounded)
				}
				// note: the behavior of rounded is to munge non-significant digits
				prefix := strings.TrimRight(rounded, `0`)
				if len(prefix) != 0 {
					prefix = prefix[:len(prefix)-1]
				}
				if !strings.HasPrefix(s, prefix) {
					t.Fatalf(`unexpected result: %s !~= %s`, s, rounded)
				}
			} else if len(rounded) < len(s)-1-decimals {
				t.Fatal(`unexpected mantissa size in min unique:`, len(rounded), len(s)-1-decimals, s)
			} else if len(rounded) == len(s)-1-decimals {
				if !strings.HasPrefix(s, rounded) {
					t.Fatalf(`unexpected result: %s not prefixed with %s`, s, rounded)
				}
			} else if rounded[len(s)-1-decimals] != '.' || !strings.HasPrefix(s, rounded[:len(s)-decimals]) {
				t.Fatalf(`unexpected result: %s not prefixed with %s`, s, rounded)
			}
		}
	})
}

func Test_approximateDecimalBufferSizeWithFixedDecimals(t *testing.T) {
	for _, tc := range [...]struct {
		name                         string
		value                        *big.Float
		bytes, significand, decimals int
	}{
		{`float64 1.5999999999999943`, big.NewFloat(1.5999999999999943), 35, 17, 17},
		{`float64 -1.5999999999999943`, big.NewFloat(-1.5999999999999943), 36, 17, 17},
		{`42360000`, new(big.Float).SetPrec(128).SetInt64(42360000), 40, 40, 0},
		{`-42360000`, new(big.Float).SetPrec(128).SetInt64(-42360000), 41, 40, 0},
		{`float64 0.1`, big.NewFloat(0.1), 35, 17, 17},
		{`float64 -0.1`, big.NewFloat(-0.1), 36, 17, 17},
		{`float64 0.9`, big.NewFloat(0.999999999999999), 35, 17, 17},
		{`float64 -0.9`, big.NewFloat(-0.999999999999999), 36, 17, 17},
		{`float64 1.999999999999999e+7`, big.NewFloat(1.999999999999999e+7), 28, 17, 10},
	} {
		t.Run(tc.name, func(t *testing.T) {
			b, s, d := approximateDecimalBufferSizeWithFixedDecimals((*bigFloatInfo)(tc.value), 0)
			if b != tc.bytes {
				t.Errorf(`unexpected bytes: %d != %d`, b, tc.bytes)
			}
			if s != tc.significand {
				t.Errorf(`unexpected significand: %d != %d`, s, tc.significand)
			}
			if d != tc.decimals {
				t.Errorf(`unexpected decimals: %d != %d`, d, tc.decimals)
			}
		})
	}
}
