{
  "project": "eventloop-correctness-fixes",
  "status": "IN_PROGRESS",
  "created": "2026-01-15",
  "summary": "Comprehensive fix implementation for 10 identified defects in the eventloop package, ranging from CRITICAL (initPoller race, data races, write-after-free) to THEORETICAL (sequence wrap-around). All fixes must pass on Linux, Darwin, and with race detector enabled.",
  "phases": [
    {
      "id": "phase-1-critical",
      "name": "Critical Defects",
      "status": "NOT_STARTED",
      "description": "Fix all CRITICAL severity bugs that cause panics, deadlocks, or data corruption",
      "tasks": [
        {
          "id": "task-1.1",
          "title": "Fix initPoller CAS race with sync.Once",
          "description": "Replace atomic.Bool + CompareAndSwap pattern with sync.Once in both poller_darwin.go and poller_linux.go. The current implementation incorrectly returns nil when losing the CAS race, allowing goroutines to proceed before Init() completes. sync.Once ensures all callers block until initialization is complete.",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/poller_darwin.go",
            "eventloop/poller_linux.go"
          ],
          "changes": [
            "Add 'once sync.Once' field to ioPoller struct",
            "Remove 'initialized atomic.Bool' field",
            "Rewrite initPoller() to use p.once.Do(func() {...})",
            "Capture any error from p.p.Init() in closure variable"
          ],
          "verification": "go test -race -v ./eventloop/... -run TestPoller_Init_Race -count=10",
          "dependencies": []
        },
        {
          "id": "task-1.2",
          "title": "Fix ioPoller.closed data race with atomic.Bool",
          "description": "Change 'closed bool' to 'closed atomic.Bool' in ioPoller struct. Replace all reads with .Load() and all writes with .Store(true). Current non-atomic access causes data race between initPoller() and closePoller().",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/poller_darwin.go",
            "eventloop/poller_linux.go"
          ],
          "changes": [
            "Change 'closed bool' to 'closed atomic.Bool' in ioPoller struct",
            "Replace 'p.closed = true' with 'p.closed.Store(true)'",
            "Replace 'if p.closed' with 'if p.closed.Load()'"
          ],
          "verification": "go test -race -v ./eventloop/... -run TestIOPollerClosedDataRace -count=10",
          "dependencies": ["task-1.1"]
        },
        {
          "id": "task-1.3",
          "title": "Fix MicrotaskRing.Pop Write-After-Free race",
          "description": "In Pop(), reorder the sequence clear and head advance operations. Currently head is advanced BEFORE clearing the sequence guard, allowing a producer to claim and write to the slot while consumer still holds a reference. Fix: Clear r.seq[idx].Store(0) BEFORE r.head.Add(1).",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/ingress.go"
          ],
          "changes": [
            "In MicrotaskRing.Pop(), move r.seq[(head)%4096].Store(0) to execute BEFORE r.head.Add(1)",
            "Add comment explaining the ordering requirement"
          ],
          "verification": "go test -race -v ./eventloop/... -run TestMicrotaskRing_WriteAfterFree_Race -count=5 -timeout=60s",
          "dependencies": []
        },
        {
          "id": "task-1.4",
          "title": "Fix MicrotaskRing FIFO violation in overflow handling",
          "description": "In Push(), when overflow buffer is non-empty, new tasks must go to overflow even if ring has space. Currently new tasks can bypass older overflow tasks, violating FIFO ordering. Fix: Check overflow buffer at start of Push() and append there if non-empty.",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/ingress.go"
          ],
          "changes": [
            "At start of MicrotaskRing.Push(), lock overflowMu and check len(r.overflow) > 0",
            "If overflow non-empty, append to overflow and return true",
            "Unlock and continue with fast path only if overflow was empty"
          ],
          "verification": "go test -v ./eventloop/... -run TestMicrotaskRing_FIFO_Violation -count=10",
          "dependencies": []
        }
      ]
    },
    {
      "id": "phase-2-high",
      "name": "High Severity Defects",
      "status": "NOT_STARTED",
      "description": "Fix HIGH severity bugs that cause liveness failures or inconsistent behavior",
      "tasks": [
        {
          "id": "task-2.1",
          "title": "Fix PopBatch inconsistency with Pop spin-wait",
          "description": "PopBatch does not spin-wait when head.next is nil but tail != head (producer in-flight). Add the same spin-wait logic that exists in Pop() to PopBatch().",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/ingress.go"
          ],
          "changes": [
            "In PopBatch loop, when next == nil, check if q.tail.Load() != head",
            "If tail != head, spin with runtime.Gosched() like Pop() does",
            "Only break loop when both next == nil AND tail == head"
          ],
          "verification": "go test -v ./eventloop/... -run TestPopBatch -count=10",
          "dependencies": ["task-1.3", "task-1.4"]
        },
        {
          "id": "task-2.2",
          "title": "Fix nil input infinite loop in MicrotaskRing.Pop",
          "description": "When Pop() encounters a nil task in the ring, it loops forever without advancing head. Fix: When fn == nil, still consume the slot by clearing seq and advancing head, then continue to next slot.",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/ingress.go"
          ],
          "changes": [
            "In MicrotaskRing.Pop(), when fn == nil after reading slot",
            "Clear the sequence guard: r.seq[idx].Store(0)",
            "Advance head: r.head.Add(1)",
            "Continue to next iteration instead of returning nil"
          ],
          "verification": "go test -v ./eventloop/... -run TestMicrotaskRing_NilInput_Liveness -timeout=30s",
          "dependencies": ["task-1.3"]
        }
      ]
    },
    {
      "id": "phase-3-moderate",
      "name": "Moderate Severity Defects",
      "status": "NOT_STARTED",
      "description": "Fix MODERATE severity bugs affecting reliability and consistency",
      "tasks": [
        {
          "id": "task-3.1",
          "title": "Fix closeFDs double-close with sync.Once",
          "description": "closeFDs() can be called twice: once from shutdown() on poll error, and again from run() loop termination check. Use sync.Once to ensure FDs are only closed once.",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/loop.go"
          ],
          "changes": [
            "Add 'closeOnce sync.Once' field to Loop struct",
            "Wrap closeFDs() body in l.closeOnce.Do(func() {...})"
          ],
          "verification": "go test -v ./eventloop/... -run TestCloseFDsInvokedOnce -count=10",
          "dependencies": []
        },
        {
          "id": "task-3.2",
          "title": "Fix platform error inconsistency",
          "description": "Darwin returns errEventLoopClosed while Linux returns ErrPollerClosed for the same condition (initPoller when closed). Standardize to ErrPollerClosed on both platforms.",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/poller_darwin.go"
          ],
          "changes": [
            "In poller_darwin.go initPoller(), change 'errEventLoopClosed' to 'ErrPollerClosed'",
            "Ensure ErrPollerClosed is exported/defined consistently"
          ],
          "verification": "go test -v ./eventloop/... -run TestInitPollerClosedReturnsConsistentError",
          "dependencies": ["task-1.1", "task-1.2"]
        },
        {
          "id": "task-3.3",
          "title": "Fix pollIO method location inconsistency",
          "description": "Linux has pollIO as method on ioPoller while Darwin has it on Loop. Standardize method receiver across platforms to ensure consistent API.",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/poller_darwin.go",
            "eventloop/poller_linux.go"
          ],
          "changes": [
            "Audit pollIO method receivers on both platforms",
            "Standardize to consistent receiver (recommend ioPoller)",
            "Update any callers that depend on the method location"
          ],
          "verification": "go build ./eventloop/... on both darwin and linux",
          "dependencies": []
        }
      ]
    },
    {
      "id": "phase-4-theoretical",
      "name": "Theoretical Defects",
      "status": "NOT_STARTED",
      "description": "Fix THEORETICAL/LOW severity edge cases",
      "tasks": [
        {
          "id": "task-4.1",
          "title": "Fix sequence counter wrap-around",
          "description": "tailSeq is uint64 that wraps to 0 after 2^64 operations. Since 0 is sentinel for empty slot, this causes incorrect behavior. Fix: In Push(), if tailSeq.Add(1) returns 0, increment again.",
          "status": "NOT_STARTED",
          "files": [
            "eventloop/ingress.go"
          ],
          "changes": [
            "In MicrotaskRing.Push(), after seq := r.tailSeq.Add(1)",
            "Add check: if seq == 0 { seq = r.tailSeq.Add(1) }",
            "Add comment explaining 0 is reserved sentinel"
          ],
          "verification": "go test -v ./eventloop/... -run TestMicrotaskRing -count=5",
          "dependencies": ["task-1.4"]
        }
      ]
    },
    {
      "id": "phase-5-validation",
      "name": "Comprehensive Validation",
      "status": "NOT_STARTED",
      "description": "Run all tests with race detector and verify cross-platform correctness",
      "tasks": [
        {
          "id": "task-5.1",
          "title": "Run all regression tests",
          "description": "Execute all eventloop tests including new correctness tests to verify fixes don't break existing functionality.",
          "status": "NOT_STARTED",
          "files": [],
          "changes": [],
          "verification": "go test -v ./eventloop/... -count=3",
          "dependencies": ["task-1.1", "task-1.2", "task-1.3", "task-1.4", "task-2.1", "task-2.2", "task-3.1", "task-3.2", "task-3.3", "task-4.1"]
        },
        {
          "id": "task-5.2",
          "title": "Run race detector on all platforms",
          "description": "Execute full test suite with -race flag to verify no data races remain after all fixes.",
          "status": "NOT_STARTED",
          "files": [],
          "changes": [],
          "verification": "go test -race -v ./eventloop/... -count=3 -timeout=5m",
          "dependencies": ["task-5.1"]
        },
        {
          "id": "task-5.3",
          "title": "Verify make all passes",
          "description": "Run the full make all target to ensure all quality gates pass including linting, formatting, and tests.",
          "status": "NOT_STARTED",
          "files": [],
          "changes": [],
          "verification": "make all 2>&1 | tee build.log | tail -n 50",
          "dependencies": ["task-5.2"]
        },
        {
          "id": "task-5.4",
          "title": "Cross-platform CI verification",
          "description": "Verify tests pass on Linux, Darwin (macOS), and with race detector. All platforms must show 0 failures.",
          "status": "NOT_STARTED",
          "files": [],
          "changes": [],
          "verification": "CI pipeline passes on ubuntu-latest, macos-latest with race detection",
          "dependencies": ["task-5.3"]
        }
      ]
    }
  ],
  "verification": {
    "command": "make all 2>&1 | fold -w 200 | tee build.log | tail -n 30",
    "requirements": [
      "All tests pass with -race flag",
      "No data races detected",
      "All platforms (linux, darwin) build and test successfully",
      "No regressions in existing functionality",
      "FIFO ordering maintained in MicrotaskRing",
      "initPoller correctly blocks concurrent callers",
      "closeFDs called exactly once per Loop lifecycle"
    ]
  },
  "defect_mapping": {
    "CRITICAL_1_initPoller_race": "task-1.1",
    "CRITICAL_2_closed_data_race": "task-1.2",
    "CRITICAL_3_write_after_free": "task-1.3",
    "CRITICAL_4_fifo_violation": "task-1.4",
    "HIGH_5_popbatch_inconsistency": "task-2.1",
    "HIGH_6_nil_infinite_loop": "task-2.2",
    "MODERATE_7_closefds_double_close": "task-3.1",
    "MODERATE_8_platform_error_inconsistency": "task-3.2",
    "MODERATE_9_pollIO_location_inconsistency": "task-3.3",
    "THEORETICAL_10_sequence_wraparound": "task-4.1"
  },
  "notes": [
    "Tasks 1.1 and 1.2 must be done together as they modify the same ioPoller struct",
    "Task 1.3 (write-after-free) and 1.4 (FIFO violation) are independent and can be parallelized",
    "Phase 5 validation cannot begin until all implementation phases complete",
    "Existing regression tests from previous blueprint are already in place"
  ]
}
